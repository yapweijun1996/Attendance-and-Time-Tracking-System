import{j as e,r as l,c as nn}from"./vendor-C_7N_xUH.js";import{P as an}from"./vendor-pouchdb-Dd9haHd_.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const rn="modulepreload",on=function(t){return"/"+t},qt={},q=function(s,n,a){let r=Promise.resolve();if(n&&n.length>0){let d=function(u){return Promise.all(u.map(m=>Promise.resolve(m).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=i?.nonce||i?.getAttribute("nonce");r=d(n.map(u=>{if(u=on(u),u in qt)return;qt[u]=!0;const m=u.endsWith(".css"),h=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${h}`))return;const p=document.createElement("link");if(p.rel=m?"stylesheet":rn,m||(p.as="script"),p.crossOrigin="",p.href=u,c&&p.setAttribute("nonce",c),document.head.appendChild(p),m)return new Promise((x,f)=>{p.addEventListener("load",x),p.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return s().catch(o)})};function ln(t){return{id:t.eventId,action:t.action,clientTs:t.clientTs,geoStatus:t.geoPolicyResult.status,syncState:t.syncState}}function Kt(t){const s=Date.parse(t);return Number.isNaN(s)?0:s}function cn(t){if(t===null||typeof t!="object")return!1;const s=t;return s.type==="ATTENDANCE_LOG"&&typeof s.eventId=="string"&&(s.action==="IN"||s.action==="OUT")&&typeof s.clientTs=="string"&&typeof s.syncState=="string"&&s.geoPolicyResult!==void 0&&typeof s.geoPolicyResult.status=="string"}function dn(t){return{_id:`log::${t.eventId}`,type:"ATTENDANCE_LOG",eventId:t.eventId,staffId:t.staffId,deviceId:t.deviceId,action:t.action,clientTs:t.clientTs,serverTs:null,syncState:t.syncState,verify:{score:t.verifyScore,result:"PASS"},geoPolicyResult:{status:t.geoStatus,distanceM:t.distanceM},gps:{lat:t.lat,lng:t.lng,accuracyM:t.accuracyM},_attachments:t.evidenceAttachment?{"evidence.jpg":t.evidenceAttachment}:void 0}}async function St(t=30){const{pouchDBService:s}=await q(async()=>{const{pouchDBService:i}=await Promise.resolve().then(()=>ne);return{pouchDBService:i}},void 0),a=await s.getDatabase().allDocs({include_docs:!0}),r=[];for(const i of a.rows)cn(i.doc)&&r.push(i.doc);return r.sort((i,c)=>Kt(c.clientTs)-Kt(i.clientTs)).slice(0,t).map(i=>ln(i))}async function un(t){const{pouchDBService:s}=await q(async()=>{const{pouchDBService:n}=await Promise.resolve().then(()=>ne);return{pouchDBService:n}},void 0);s.init(),await s.put(t)}function mn(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===409||s.name==="conflict"}async function hn(t){try{return await un(t),{status:"CREATED"}}catch(s){if(mn(s))return{status:"DUPLICATE"};throw s}}const fn=[{route:"/admin/dashboard",label:"Dashboard",hint:"Overview",icon:"dashboard"},{route:"/admin/logs",label:"Logs",hint:"Attendance Feed",icon:"logs"},{route:"/admin/staff",label:"Staff",hint:"People & Roles",icon:"staff"},{route:"/admin/settings",label:"Settings",hint:"Policy Controls",icon:"settings"},{route:"/admin/exports",label:"Exports",hint:"Payroll CSV",icon:"exports"},{route:"/admin/audit",label:"Audit",hint:"Action History",icon:"audit"}];function xn({name:t,active:s}){const n=s?"currentColor":"#335170";switch(t){case"dashboard":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M4 4h7v7H4V4Zm9 0h7v4h-7V4ZM13 10h7v10h-7V10ZM4 13h7v7H4v-7Z",stroke:n,strokeWidth:"1.7"})});case"logs":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M6 4h12a2 2 0 0 1 2 2v12H4V6a2 2 0 0 1 2-2Zm2 5h8M8 13h8M8 17h5",stroke:n,strokeWidth:"1.7",strokeLinecap:"round"})});case"staff":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M8 11a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3 19a5 5 0 0 1 10 0M11 19a5 5 0 0 1 10 0",stroke:n,strokeWidth:"1.7",strokeLinecap:"round"})});case"settings":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M10.9 4h2.2l.6 2.1a6.7 6.7 0 0 1 1.8.8l2-1 1.6 1.6-1 2c.3.6.6 1.2.8 1.8l2.1.6v2.2l-2.1.6a6.8 6.8 0 0 1-.8 1.8l1 2-1.6 1.6-2-1a6.8 6.8 0 0 1-1.8.8l-.6 2.1h-2.2l-.6-2.1a6.7 6.7 0 0 1-1.8-.8l-2 1-1.6-1.6 1-2a6.8 6.8 0 0 1-.8-1.8L3 13.1v-2.2l2.1-.6a6.7 6.7 0 0 1 .8-1.8l-1-2L6.5 4.9l2 1c.6-.3 1.2-.6 1.8-.8L10.9 4Zm1.1 5.3a2.7 2.7 0 1 0 0 5.4 2.7 2.7 0 0 0 0-5.4Z",stroke:n,strokeWidth:"1.5",strokeLinejoin:"round"})});case"exports":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M12 4v10m0 0 4-4m-4 4-4-4M5 20h14",stroke:n,strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"})});case"audit":return e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M12 6v6l4 2m5-2a9 9 0 1 1-3.2-6.9",stroke:n,strokeWidth:"1.7",strokeLinecap:"round"})})}}function pn({currentRoute:t,collapsed:s,onToggleCollapse:n,onNavigate:a,onSwitchToStaff:r}){return e.jsxs("aside",{className:`hidden h-screen shrink-0 flex-col border-r border-slate-800 bg-slate-950 text-slate-300 py-8 md:flex transition-all duration-300 fixed left-0 top-0 z-30 ${s?"w-[80px]":"w-64"}`,children:[e.jsxs("div",{className:`mb-10 flex items-center px-4 ${s?"flex-col gap-4":"justify-between"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 overflow-hidden",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-sky-500 text-white shadow-lg shadow-sky-500/20",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M4 7h16M4 12h10M4 17h7",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round"})})}),!s&&e.jsxs("div",{className:"animate-in fade-in slide-in-from-left-2 duration-300",children:[e.jsx("h2",{className:"text-sm font-black tracking-tight text-white uppercase italic",children:"SATTS Central"}),e.jsx("p",{className:"text-[9px] font-bold text-slate-500 uppercase tracking-[0.2em]",children:"ERP Core v1.0"})]})]}),!s&&e.jsx("button",{type:"button",onClick:n,className:"inline-flex h-7 w-7 items-center justify-center rounded-lg hover:bg-slate-800 text-slate-500 hover:text-white transition-colors","aria-label":"Collapse sidebar",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M15 19l-7-7 7-7",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),s?e.jsx("div",{className:"mx-auto mb-6 flex h-10 w-10 items-center justify-center rounded-full hover:bg-slate-800 cursor-pointer text-slate-500 hover:text-white transition-all",onClick:n,children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none",children:e.jsx("path",{d:"M9 5l7 7-7 7",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}):e.jsx("p",{className:"mb-4 px-6 text-[10px] font-bold uppercase tracking-[0.2em] text-slate-600",children:"Navigator"}),e.jsx("nav",{className:"flex-1 space-y-1 px-3",children:fn.map(o=>{const i=o.route===t;return e.jsxs("button",{type:"button",onClick:()=>a(o.route),"aria-current":i?"page":void 0,title:s?o.label:void 0,className:`group relative flex w-full items-center rounded-xl transition-all duration-200 ${s?"justify-center py-3":"gap-3 px-3 py-2.5 text-left"} ${i?"bg-slate-800 text-white shadow-sm":"text-slate-400 hover:bg-slate-900 hover:text-slate-200"}`,children:[e.jsx("div",{className:`flex h-6 w-6 shrink-0 items-center justify-center transition-colors ${i?"text-sky-400":"text-slate-500 group-hover:text-slate-300"}`,children:e.jsx(xn,{name:o.icon,active:i})}),s?null:e.jsx("div",{className:"min-w-0",children:e.jsx("p",{className:"text-sm font-bold tracking-tight",children:o.label})}),i&&e.jsx("div",{className:"absolute left-0 h-5 w-1 rounded-r-full bg-sky-500 shadow-[0_0_10px_rgba(14,165,233,0.5)]"})]},o.route)})}),e.jsx("div",{className:`mt-auto p-4 border-t border-slate-900 ${s?"flex justify-center":""}`,children:e.jsxs("button",{type:"button",onClick:r,className:`flex items-center gap-3 rounded-xl transition-all duration-200 ${s?"h-11 w-11 justify-center bg-slate-900 text-slate-500 hover:bg-slate-800 hover:text-white":"w-full bg-slate-900 px-4 py-3 text-left text-slate-400 hover:bg-slate-800 hover:text-white"}`,title:"Switch to Staff Interface",children:[e.jsx("div",{className:"flex h-5 w-5 shrink-0 items-center justify-center",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),!s&&e.jsx("span",{className:"text-xs font-bold tracking-tight",children:"Staff Workspace"})]})})]})}const gn=[{route:"/admin/dashboard",shortLabel:"Dash"},{route:"/admin/logs",shortLabel:"Logs"},{route:"/admin/staff",shortLabel:"Staff"},{route:"/admin/settings",shortLabel:"Settings"},{route:"/admin/exports",shortLabel:"Exports"},{route:"/admin/audit",shortLabel:"Audit"}];function bn({currentRoute:t,onNavigate:s,onLogout:n}){return e.jsxs("header",{className:"sticky top-0 z-20 border-b border-slate-100 bg-white/80 backdrop-blur-md",children:[e.jsxs("div",{className:"mx-auto flex w-full max-w-7xl items-center justify-between gap-3 px-4 py-3 sm:px-8",children:[e.jsx("div",{className:"md:hidden",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-lg bg-slate-900 flex items-center justify-center text-white",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M4 7h16M4 12h10M4 17h7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),e.jsx("p",{className:"text-sm font-bold tracking-tight text-slate-900",children:"SATTS Admin"})]})}),e.jsx("div",{className:"hidden md:block text-xs font-medium text-slate-400",children:"Last active: Just now"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:n,className:"ui-btn ui-btn-ghost min-h-0 px-3 py-1.5 text-xs",children:"Logout"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-500",children:"AD"})]})]}),e.jsx("nav",{className:"mx-auto flex w-full max-w-7xl gap-1.5 overflow-x-auto px-4 pb-3 sm:px-6 md:hidden no-scrollbar",children:gn.map(a=>{const r=a.route===t;return e.jsx("button",{type:"button",onClick:()=>s(a.route),className:`rounded-full px-4 py-1.5 text-xs font-bold transition-all whitespace-nowrap ${r?"bg-slate-900 text-white shadow-md shadow-slate-200":"bg-slate-50 text-slate-500 hover:bg-slate-100"}`,children:a.shortLabel},a.route)})})]})}const $e={LOCAL_ONLY:{text:"text-amber-600",pill:"bg-amber-50 text-amber-700 ring-amber-200"},SYNCING:{text:"text-sky-600",pill:"bg-sky-50 text-sky-700 ring-sky-200"},SYNCED:{text:"text-emerald-600",pill:"bg-emerald-50 text-emerald-700 ring-emerald-200"},FAILED:{text:"text-rose-600",pill:"bg-rose-50 text-rose-700 ring-rose-200"}};function wn(t){return t.reduce((s,n)=>(s[n.syncState]+=1,s),{LOCAL_ONLY:0,SYNCING:0,SYNCED:0,FAILED:0})}function Nn({recentEvents:t}){const s=t.length,n=t.filter(i=>i.geoStatus==="IN_RANGE").length,a=t.filter(i=>i.geoStatus==="OUT_OF_RANGE").length,r=t.filter(i=>i.geoStatus==="LOCATION_UNAVAILABLE").length,o=wn(t);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"grid gap-6 sm:grid-cols-2 xl:grid-cols-5",children:[e.jsx(ke,{label:"Today Logs",value:s,icon:e.jsx("svg",{className:"h-6 w-6 text-slate-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx(ke,{label:"In Range",value:n,trend:`${Math.round(n/(s||1)*100)}%`,colorClass:"text-emerald-600",icon:e.jsxs("svg",{className:"h-6 w-6 text-emerald-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]})}),e.jsx(ke,{label:"Out Of Range",value:a,colorClass:"text-rose-600",icon:e.jsx("svg",{className:"h-6 w-6 text-rose-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx(ke,{label:"Pending Sync",value:o.LOCAL_ONLY,colorClass:"text-amber-600",icon:e.jsx("svg",{className:"h-6 w-6 text-amber-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}),e.jsx(ke,{label:"Location N/A",value:r,colorClass:"text-slate-600",icon:e.jsx("svg",{className:"h-6 w-6 text-slate-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01M4.93 19h14.14c1.2 0 1.96-1.3 1.35-2.35L13.35 4.35c-.6-1.05-2.1-1.05-2.7 0L3.58 16.65C2.97 17.7 3.73 19 4.93 19z"})})})]}),e.jsxs("section",{className:"ui-card flex flex-col overflow-hidden",children:[e.jsx("div",{className:"border-b border-slate-100 bg-slate-50/50 px-6 py-4",children:e.jsx("h2",{className:"ui-title text-sm font-semibold text-slate-700",children:"Storage & Sync Distribution"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-4",children:[e.jsx(Be,{label:"Local Only",count:o.LOCAL_ONLY,tone:$e.LOCAL_ONLY}),e.jsx(Be,{label:"Syncing",count:o.SYNCING,tone:$e.SYNCING}),e.jsx(Be,{label:"Synced",count:o.SYNCED,tone:$e.SYNCED}),e.jsx(Be,{label:"Failed",count:o.FAILED,tone:$e.FAILED})]})})]})]})}function ke({label:t,value:s,icon:n,trend:a,colorClass:r="text-slate-900"}){return e.jsxs("article",{className:"ui-card group p-6 hover:-translate-y-1",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{className:"rounded-xl bg-slate-50 p-2.5 transition-colors group-hover:bg-white",children:n}),a&&e.jsx("span",{className:"rounded-full bg-emerald-50 px-2.5 py-1 text-[11px] font-bold text-emerald-600 shadow-sm",children:a})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"ui-kicker",children:t}),e.jsx("p",{className:`ui-title text-3xl ${r}`,children:s})]})]})}function Be({label:t,count:s,tone:n}){return e.jsxs("div",{className:"flex flex-col rounded-2xl border border-slate-100 bg-white p-4 shadow-sm transition-all hover:border-slate-200 hover:shadow-md",children:[e.jsx("div",{className:"mb-2",children:e.jsx("span",{className:`ui-pill ring-1 ${n.pill}`,children:t})}),e.jsx("p",{className:`text-xl font-bold ${n.text}`,children:s})]})}const yn={LOCAL_ONLY:"bg-amber-100 text-amber-700 ring-amber-200",SYNCING:"bg-sky-100 text-sky-700 ring-sky-200",SYNCED:"bg-emerald-100 text-emerald-700 ring-emerald-200",FAILED:"bg-rose-100 text-rose-700 ring-rose-200"};function Me({state:t}){return e.jsx("span",{className:`ui-pill ring-1 ${yn[t]}`,children:t})}function Jt(t){return t==="IN"?"bg-emerald-50 text-emerald-700 ring-emerald-200":"bg-sky-50 text-sky-700 ring-sky-200"}function Xt(t){return t==="IN_RANGE"?"bg-emerald-50 text-emerald-700 ring-emerald-200":t==="OUT_OF_RANGE"?"bg-rose-50 text-rose-700 ring-rose-200":"bg-slate-100 text-slate-700 ring-slate-200"}function Qt(t){return t.replace(/_/g," ")}function Zt({recentEvents:t}){const[s,n]=l.useState("ALL"),[a,r]=l.useState("ALL"),o=l.useMemo(()=>t.filter(i=>{const c=s==="ALL"||i.action===s,d=a==="ALL"||i.geoStatus===a;return c&&d}),[s,a,t]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Filters"}),e.jsxs("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:[e.jsxs("label",{className:"ui-note",children:["Action",e.jsxs("select",{value:s,onChange:i=>n(i.target.value),className:"ui-input",children:[e.jsx("option",{value:"ALL",children:"All"}),e.jsx("option",{value:"IN",children:"IN"}),e.jsx("option",{value:"OUT",children:"OUT"})]})]}),e.jsxs("label",{className:"ui-note",children:["Geo Status",e.jsxs("select",{value:a,onChange:i=>r(i.target.value),className:"ui-input",children:[e.jsx("option",{value:"ALL",children:"All"}),e.jsx("option",{value:"IN_RANGE",children:"IN_RANGE"}),e.jsx("option",{value:"OUT_OF_RANGE",children:"OUT_OF_RANGE"}),e.jsx("option",{value:"LOCATION_UNAVAILABLE",children:"LOCATION_UNAVAILABLE"})]})]})]})]}),e.jsxs("section",{className:"ui-table-shell",children:[e.jsx("div",{className:"border-b border-[var(--color-border)] px-4 py-3",children:e.jsx("h2",{className:"ui-title text-sm",children:"Attendance Logs"})}),e.jsx("div",{className:"hidden lg:block",children:e.jsxs("table",{className:"ui-table",children:[e.jsx("thead",{className:"ui-thead",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"ui-th",children:"Event ID"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Action"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Client Time"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Geo"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Sync"})]})}),e.jsx("tbody",{children:o.map(i=>e.jsxs("tr",{className:"ui-row",children:[e.jsx("td",{className:"ui-td font-mono text-xs text-slate-600",children:i.id}),e.jsx("td",{className:"ui-td",children:e.jsx("span",{className:`ui-pill ring-1 ${Jt(i.action)}`,children:i.action})}),e.jsx("td",{className:"ui-td text-slate-700",children:new Date(i.clientTs).toLocaleString()}),e.jsx("td",{className:"ui-td",children:e.jsx("span",{className:`ui-pill ring-1 ${Xt(i.geoStatus)}`,children:Qt(i.geoStatus)})}),e.jsx("td",{className:"ui-td",children:e.jsx(Me,{state:i.syncState})})]},i.id))})]})}),e.jsx("ul",{className:"space-y-2 p-3 lg:hidden",children:o.map(i=>e.jsxs("li",{className:"ui-card-soft p-3",children:[e.jsx("p",{className:"font-mono text-xs text-slate-500",children:i.id}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:`ui-pill ring-1 ${Jt(i.action)}`,children:i.action}),e.jsx("span",{className:`ui-pill ring-1 ${Xt(i.geoStatus)}`,children:Qt(i.geoStatus)})]}),e.jsx("p",{className:"ui-note-xs",children:new Date(i.clientTs).toLocaleString()}),e.jsx("div",{className:"mt-2",children:e.jsx(Me,{state:i.syncState})})]},i.id))}),o.length===0?e.jsx("p",{className:"ui-note px-4 py-6",children:"No logs matched current filters."}):null]})]})}function jn({staffId:t,name:s,dept:n,initialPassword:a,saving:r,onStaffIdChange:o,onNameChange:i,onDeptChange:c,onInitialPasswordChange:d,onSubmit:u}){return e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h3",{className:"ui-title text-sm",children:"Create Staff"}),e.jsxs("div",{className:"mt-3 grid gap-3 sm:grid-cols-4",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Staff ID",e.jsx("input",{value:t,onChange:m=>o(m.target.value.toUpperCase()),className:"ui-input",placeholder:"STAFF_001"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Name",e.jsx("input",{value:s,onChange:m=>i(m.target.value),className:"ui-input",placeholder:"Jane Tan"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Department",e.jsx("input",{value:n,onChange:m=>c(m.target.value),className:"ui-input",placeholder:"Operations"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Temporary Password",e.jsx("input",{value:a,onChange:m=>d(m.target.value),className:"ui-input",type:"password",autoComplete:"new-password",placeholder:"At least 6 chars"})]})]}),e.jsx("button",{type:"button",onClick:u,disabled:r,className:"ui-btn ui-btn-primary mt-4 disabled:cursor-not-allowed disabled:opacity-60",children:r?"Saving...":"Create Staff"})]})}function vn(t){const s=new Date().toISOString().replace(/[:.]/g,"-");return`staff-delete-backup-${t}-${s}.json`}function Sn(t,s){const n=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function En({staff:t,deleting:s,impact:n,impactLoading:a,impactError:r,onClose:o,onExport:i,onConfirm:c}){const[d,u]=l.useState(""),[m,h]=l.useState(null),[p,x]=l.useState(!1),[f,g]=l.useState(null);if(!t)return null;const b=t.staffId,y=!a&&!r&&n!==null,N=!!(n&&(n.hasUserProfile||n.attendanceCount>0)),w=y&&N,j=f!==null;return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 px-4",children:e.jsxs("section",{className:"ui-card w-full max-w-lg p-5",children:[e.jsx("p",{className:"ui-kicker",children:"Delete Staff"}),e.jsx("h3",{className:"ui-title text-lg text-rose-700",children:b}),e.jsx("p",{className:"ui-note mt-1",children:"This action deletes the staff record from local database."}),e.jsxs("p",{className:"ui-note mt-1",children:["Type ",e.jsx("strong",{children:b})," to confirm."]}),e.jsxs("section",{className:"mt-4 rounded-xl border border-slate-200 bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-wider text-slate-500",children:"Impact Check"}),a?e.jsx("p",{className:"mt-2 text-xs text-slate-600",children:"Checking related records..."}):r?e.jsx("p",{className:"mt-2 text-xs text-rose-700",children:r}):n?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"mt-2 text-xs text-slate-700",children:["Linked USER_PROFILE: ",e.jsx("strong",{children:n.hasUserProfile?"YES":"NO"})]}),e.jsxs("p",{className:"mt-1 text-xs text-slate-700",children:["ATTENDANCE_LOG count: ",e.jsx("strong",{children:n.attendanceCount})]}),n.hasUserProfile||n.attendanceCount>0?e.jsx("p",{className:"mt-2 text-xs font-semibold text-amber-700",children:"Warning: deleting staff will not remove linked profile/log records."}):e.jsx("p",{className:"mt-2 text-xs text-emerald-700",children:"No linked profile or attendance logs found."})]}):e.jsx("p",{className:"mt-2 text-xs text-slate-600",children:"No impact data."})]}),w?e.jsxs("section",{className:"mt-3 rounded-xl border border-amber-300 bg-amber-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold text-amber-800",children:"Export linked data before delete is required."}),e.jsx("button",{type:"button",disabled:p||s,className:"ui-btn ui-btn-ghost mt-2 min-h-0 px-3 py-1.5 text-xs disabled:cursor-not-allowed disabled:opacity-60",onClick:()=>{h(null),g(null),x(!0),i(b).then(v=>{Sn(vn(b),v),g("Linked data exported successfully.")}).catch(v=>{h(v instanceof Error?v.message:"Failed to export linked data.")}).finally(()=>{x(!1)})},children:p?"Exporting...":"Export Linked Data (JSON)"}),f?e.jsx("p",{className:"mt-2 text-xs text-emerald-700",children:f}):null]}):null,e.jsxs("label",{className:"mt-4 block text-sm text-slate-700",children:["Confirmation",e.jsx("input",{value:d,onChange:v=>u(v.target.value.toUpperCase()),className:"ui-input",placeholder:`Type ${b}`})]}),m?e.jsx("p",{className:"ui-note-error mt-3",children:m}):null,e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:o,className:"ui-btn ui-btn-ghost",disabled:s,children:"Cancel"}),e.jsx("button",{type:"button",className:"ui-btn ui-btn-danger",disabled:s,onClick:()=>{if(a){h("Impact check is still running. Please wait.");return}if(!y){h("Impact check is unavailable. Reopen the dialog and retry.");return}if(d.trim().toUpperCase()!==b){h("Delete confirmation does not match Staff ID.");return}if(w&&!j){h("Please export linked data before deleting this staff.");return}h(null),c(b).catch(v=>{h(v instanceof Error?v.message:"Failed to delete staff.")})},children:s?"Deleting...":"Delete Staff"})]})]})})}function Cn({staff:t,saving:s,onClose:n,onSubmit:a}){const[r,o]=l.useState(t?.name??""),[i,c]=l.useState(t?.dept??""),[d,u]=l.useState(null);return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 px-4",children:e.jsxs("section",{className:"ui-card w-full max-w-lg p-5",children:[e.jsx("p",{className:"ui-kicker",children:"Edit Staff"}),e.jsx("h3",{className:"ui-title text-lg",children:t.staffId}),e.jsx("p",{className:"ui-note mt-1",children:"Update staff basic profile fields."}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Name",e.jsx("input",{value:r,onChange:m=>o(m.target.value),className:"ui-input",placeholder:"Jane Tan"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Department (optional)",e.jsx("input",{value:i,onChange:m=>c(m.target.value),className:"ui-input",placeholder:"Operations"})]})]}),d?e.jsx("p",{className:"ui-note-error mt-3",children:d}):null,e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:n,className:"ui-btn ui-btn-ghost",disabled:s,children:"Cancel"}),e.jsx("button",{type:"button",className:"ui-btn ui-btn-primary",disabled:s,onClick:()=>{const m=r.trim();if(m.length<2){u("Staff name must be at least 2 characters.");return}a({staffId:t.staffId,name:m,dept:i.trim()}).catch(h=>{u(h instanceof Error?h.message:"Failed to update staff profile.")})},children:s?"Saving...":"Save Changes"})]})]})}):null}function In({staffId:t,resetPassword:s,saving:n,onStaffIdChange:a,onResetPasswordChange:r,onSubmit:o}){return e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h3",{className:"ui-title text-sm",children:"Reset Staff Password"}),e.jsx("p",{className:"ui-note mt-1",children:"Reset will force password change at next login."}),e.jsxs("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Staff ID",e.jsx("input",{value:t,onChange:i=>a(i.target.value.toUpperCase()),className:"ui-input",placeholder:"STAFF_001"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["New Temporary Password",e.jsx("input",{value:s,onChange:i=>r(i.target.value),className:"ui-input",type:"password",autoComplete:"new-password",placeholder:"At least 6 chars"})]})]}),e.jsx("button",{type:"button",onClick:o,disabled:n,className:"ui-btn ui-btn-ghost mt-4 disabled:cursor-not-allowed disabled:opacity-60",children:n?"Processing...":"Reset Password"})]})}function An(t){return t==="ACTIVE"?"bg-emerald-50 text-emerald-700 ring-emerald-200":t==="LOCKED"?"bg-rose-50 text-rose-700 ring-rose-200":"bg-amber-50 text-amber-700 ring-amber-200"}function kn(t){return t.credentials?t.credentials.mustChangePassword?"bg-amber-50 text-amber-700 ring-amber-200":"bg-emerald-50 text-emerald-700 ring-emerald-200":"bg-slate-100 text-slate-600 ring-slate-200"}function _n(t){return t.credentials?t.credentials.mustChangePassword?"FORCE_CHANGE":"READY":"NO_PASSWORD"}function Dn({rows:t,loading:s,onEdit:n,onToggleLock:a,onDelete:r}){return e.jsx("section",{className:"ui-table-shell",children:e.jsxs("table",{className:"ui-table",children:[e.jsx("thead",{className:"ui-thead",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"ui-th",children:"Staff ID"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Name"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Dept"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Status"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Auth"}),e.jsx("th",{scope:"col",className:"ui-th",children:"Action"})]})}),e.jsx("tbody",{children:s?e.jsx("tr",{className:"ui-row",children:e.jsx("td",{className:"ui-td text-slate-500",colSpan:6,children:"Loading staff..."})}):t.length===0?e.jsx("tr",{className:"ui-row",children:e.jsx("td",{className:"ui-td text-slate-500",colSpan:6,children:"No staff records yet."})}):t.map(o=>e.jsxs("tr",{className:"ui-row",children:[e.jsx("td",{className:"ui-td font-mono text-xs font-semibold tracking-wide text-slate-700",children:o.staffId}),e.jsx("td",{className:"ui-td font-semibold text-slate-900",children:o.name}),e.jsx("td",{className:"ui-td text-slate-700",children:o.dept??"-"}),e.jsx("td",{className:"ui-td",children:e.jsx("span",{className:`ui-pill text-[11px] ring-1 ${An(o.status)}`,children:o.status})}),e.jsx("td",{className:"ui-td",children:e.jsx("span",{className:`ui-pill text-[11px] ring-1 ${kn(o)}`,children:_n(o)})}),e.jsx("td",{className:"ui-td",children:e.jsxs("div",{className:"ui-table-actions",children:[e.jsx("button",{type:"button",onClick:()=>n(o),className:"ui-btn ui-btn-ghost min-h-0 px-3 py-1.5 text-xs",children:"Edit"}),e.jsx("button",{type:"button",onClick:()=>a(o),className:"ui-btn ui-btn-ghost min-h-0 px-3 py-1.5 text-xs",children:o.status==="LOCKED"?"Unlock":"Lock"}),e.jsx("button",{type:"button",onClick:()=>r(o),className:"ui-btn ui-btn-danger min-h-0 px-3 py-1.5 text-xs",children:"Delete"})]})})]},o._id))})]})})}const Ln="org_01";function Mn(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}function Pn(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===409||s.name==="conflict"}function he(t){return t.trim().toUpperCase()}function ws(t){return t.trim().replace(/\s+/g," ")}function Tn(t){const s=t?.trim();return s||void 0}function ve(t){return t.trim()}function Pe(t){if(t.length<6||t.length>64)throw new Error("Password must be 6-64 characters.")}function Rn(t){const s=he(t.staffId),n=ws(t.name),a=ve(t.initialPassword);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Staff ID must be 3-32 chars using A-Z, 0-9, _, -.");if(n.length<2)throw new Error("Staff name must be at least 2 characters.");Pe(a)}function es(t){const s=Date.parse(t);return Number.isNaN(s)?0:s}async function Ze(t){const s=new TextEncoder().encode(t);if(typeof crypto<"u"&&crypto.subtle){const a=await crypto.subtle.digest("SHA-256",s);return`sha256:${Array.from(new Uint8Array(a),o=>o.toString(16).padStart(2,"0")).join("")}`}return`base64:${btoa(String.fromCharCode(...s))}`}function On(t){if(!t.credentials||typeof t.credentials.passwordHash!="string")throw new Error(`Staff ${t.staffId} has no password. Ask admin to reset password.`);return t.credentials}function Et(t){return`staff::${he(t)}`}async function Se(){const{pouchDBService:t}=await q(async()=>{const{pouchDBService:s}=await Promise.resolve().then(()=>ne);return{pouchDBService:s}},void 0);return t.init(),t.getDatabase()}async function Fn(t=200){const n=await(await Se()).allDocs({include_docs:!0}),a=[];for(const r of n.rows){const o=r.doc;!o||o.type!=="STAFF"||typeof o.staffId!="string"||typeof o.name!="string"||a.push(o)}return a.sort((r,o)=>es(o.createdAt)-es(r.createdAt)).slice(0,t)}async function se(t){const s=await Se();try{return await s.get(Et(t))}catch(n){if(Mn(n))return null;throw n}}async function $n(t){Rn(t);const s=await Se(),n=he(t.staffId),a=ve(t.initialPassword),r=new Date().toISOString(),o={_id:Et(n),type:"STAFF",orgId:Ln,staffId:n,name:ws(t.name),dept:Tn(t.dept),status:"PENDING_ENROLL",credentials:{passwordHash:await Ze(a),mustChangePassword:!0,passwordChangedAt:r},createdAt:r,updatedAt:r};try{const i=await s.put(o);return{...o,_rev:i.rev}}catch(i){throw Pn(i)?new Error(`Staff ID ${n} already exists.`):i}}async function Ns(t,s){const n=await Se(),a=await se(t);if(!a)throw new Error(`Staff ${he(t)} not found.`);const r={...a,status:s,updatedAt:new Date().toISOString()},o=await n.put(r);return{...r,_rev:o.rev}}async function Bn(t,s,n=!0){const a=await Se(),r=await se(t);if(!r)throw new Error(`Staff ${he(t)} not found.`);const o=ve(s);Pe(o);const i=new Date().toISOString(),c={...r,credentials:{passwordHash:await Ze(o),mustChangePassword:n,passwordChangedAt:i},updatedAt:i},d=await a.put(c);return{...c,_rev:d.rev}}async function Ct(t){const s=he(t.staffId),n=ve(t.password);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");Pe(n);const a=await se(s);if(!a)throw new Error("Invalid staff ID or password.");if(a.status==="LOCKED")throw new Error(`Staff ${s} is locked. Contact admin.`);const r=On(a);if(await Ze(n)!==r.passwordHash)throw new Error("Invalid staff ID or password.");return a}async function Un(t){const s=he(t.staffId),n=ve(t.currentPassword),a=ve(t.newPassword);if(Pe(n),Pe(a),n===a)throw new Error("New password must be different from current password.");const r=await Ct({staffId:s,password:n}),o=await Ze(a),i=new Date().toISOString(),c=await Se(),d={...r,credentials:{passwordHash:o,mustChangePassword:!1,passwordChangedAt:i},updatedAt:i},u=await c.put(d);return{...d,_rev:u.rev}}function Re(t){return t.trim().toUpperCase()}function Wn(t){return t.trim().replace(/\s+/g," ")}function Hn(t){const s=t?.trim();return s||void 0}function ys(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}async function et(){const{pouchDBService:t}=await q(async()=>{const{pouchDBService:s}=await Promise.resolve().then(()=>ne);return{pouchDBService:s}},void 0);return t.init(),t.getDatabase()}function js(t){return`user::${Re(t)}`}async function Vn(t){const s=Re(t.staffId),n=Wn(t.name);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");if(n.length<2)throw new Error("Staff name must be at least 2 characters.");const a=await se(s);if(!a)throw new Error(`Staff ${s} not found.`);const r=await et(),o={...a,name:n,dept:Hn(t.dept),updatedAt:new Date().toISOString()},i=await r.put(o);return{...o,_rev:i.rev}}async function Yn(t){const s=Re(t);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");const n=await et(),a=await n.get(Et(s));await n.remove(a)}async function Gn(t){const s=Re(t);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");const n=await et();let a=!1;try{await n.get(js(s)),a=!0}catch(i){if(!ys(i))throw i}const r=await n.allDocs({include_docs:!0});let o=0;for(const i of r.rows){const c=i.doc;c&&c.type==="ATTENDANCE_LOG"&&c.staffId===s&&(o+=1)}return{staffId:s,hasUserProfile:a,attendanceCount:o}}async function zn(t){const s=Re(t);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");const n=await et(),a=await se(s);let r=null;try{r=await n.get(js(s))}catch(c){if(!ys(c))throw c}const o=await n.allDocs({include_docs:!0}),i=[];for(const c of o.rows){const d=c.doc;d&&d.type==="ATTENDANCE_LOG"&&d.staffId===s&&i.push(d)}return{schemaVersion:"2026-02-12",staffId:s,exportedAt:new Date().toISOString(),staff:a,userProfile:r,attendanceLogs:i}}function qn(){const[t,s]=l.useState([]),[n,a]=l.useState(!0),[r,o]=l.useState(!1),[i,c]=l.useState(""),[d,u]=l.useState(""),[m,h]=l.useState(""),[p,x]=l.useState(""),[f,g]=l.useState(""),[b,y]=l.useState(""),[N,w]=l.useState(null),[j,v]=l.useState(null),[k,P]=l.useState(null),[T,_]=l.useState(!1),[S,L]=l.useState(null),[R,E]=l.useState(!1),[H,F]=l.useState(!1),[$,D]=l.useState(null),[V,B]=l.useState(null),W=l.useCallback(async()=>{a(!0);try{const A=await Fn(200);s(A),D(null)}catch(A){D(A instanceof Error?A.message:"Failed to load staff.")}finally{a(!1)}},[]);l.useEffect(()=>{W()},[W]);const Z=l.useCallback(async()=>{o(!0),D(null),B(null);try{const A=await $n({staffId:i,name:d,dept:m,initialPassword:p});c(""),u(""),h(""),x(""),B(`Staff ${A.staffId} created. Share Staff ID + temporary password for first login.`),await W()}catch(A){D(A instanceof Error?A.message:"Failed to create staff.")}finally{o(!1)}},[m,p,d,W,i]),ae=l.useCallback(async()=>{o(!0),D(null),B(null);try{const A=await Bn(f,b,!0);g(""),y(""),B(`Password reset for ${A.staffId}. User must change password at next login.`),await W()}catch(A){D(A instanceof Error?A.message:"Failed to reset password.")}finally{o(!1)}},[W,b,f]),C=l.useCallback(async A=>{D(null),B(null);try{const O=A.status==="LOCKED"?"PENDING_ENROLL":"LOCKED";await Ns(A.staffId,O),B(`Staff ${A.staffId} updated to ${O}.`),await W()}catch(O){D(O instanceof Error?O.message:"Failed to update staff.")}},[W]),U=l.useCallback(async A=>{E(!0),D(null),B(null);try{const O=await Vn({staffId:A.staffId,name:A.name,dept:A.dept});w(null),B(`Staff ${O.staffId} profile updated.`),await W()}catch(O){throw D(O instanceof Error?O.message:"Failed to update staff profile."),O}finally{E(!1)}},[W]),ee=l.useCallback(async A=>{F(!0),D(null),B(null);try{await Yn(A),v(null),B(`Staff ${A} deleted.`),await W()}catch(O){throw D(O instanceof Error?O.message:"Failed to delete staff."),O}finally{F(!1)}},[W]),Ee=l.useCallback(async A=>{v(A),P(null),L(null),_(!0);try{const O=await Gn(A.staffId);P(O)}catch(O){L(O instanceof Error?O.message:"Failed to inspect related records.")}finally{_(!1)}},[]),J=l.useCallback(()=>{v(null),P(null),L(null),_(!1)},[]),re=l.useCallback(async A=>zn(A),[]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Staff Master"}),e.jsx("p",{className:"ui-note mt-1",children:"Create staff credentials here. Staff must sign in with Staff ID + password on mobile."}),$?e.jsx("p",{className:"ui-note-error mt-2",children:$}):null,V?e.jsx("p",{className:"ui-note mt-2 text-emerald-700",children:V}):null]}),e.jsx(jn,{staffId:i,name:d,dept:m,initialPassword:p,saving:r,onStaffIdChange:c,onNameChange:u,onDeptChange:h,onInitialPasswordChange:x,onSubmit:()=>{Z()}}),e.jsx(In,{staffId:f,resetPassword:b,saving:r,onStaffIdChange:g,onResetPasswordChange:y,onSubmit:()=>{ae()}}),e.jsx(Dn,{rows:t,loading:n,onEdit:A=>{w(A)},onToggleLock:A=>{C(A)},onDelete:A=>{Ee(A)}}),e.jsx(Cn,{staff:N,saving:R,onClose:()=>w(null),onSubmit:U},N?.staffId??"no-staff"),e.jsx(En,{staff:j,deleting:H,impact:k,impactLoading:T,impactError:S,onClose:J,onExport:re,onConfirm:ee},j?.staffId??"no-delete")]})}const It="org_01",At=`policy::${It}`;function Kn(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}function Jn(){return{_id:At,type:"POLICY_CONFIG",orgId:It,verification:{threshold:.6},cooldown:{cooldownSec:300},evidence:{maxWidth:640,jpegQuality:.8,maxPerEvent:1},retention:{localDays:30,serverDays:90}}}async function vs(){const{pouchDBService:t}=await q(async()=>{const{pouchDBService:s}=await Promise.resolve().then(()=>ne);return{pouchDBService:s}},void 0);t.init();try{return await t.get(At)}catch(s){if(Kn(s))return Jn();throw s}}async function Xn(t){const{pouchDBService:s}=await q(async()=>{const{pouchDBService:r}=await Promise.resolve().then(()=>ne);return{pouchDBService:r}},void 0);s.init();const n={...t,_id:t._id||At,type:"POLICY_CONFIG",orgId:t.orgId||It},a=await s.put(n);return{...n,_rev:a.rev}}const Qn=.6;let je=null;function Zn(t){return typeof t=="number"&&Number.isFinite(t)&&t>0&&t<=1}async function ea(){if(je!==null)return je;try{const s=(await vs())?.verification?.threshold;if(Zn(s))return je=s,s}catch{}return je=Qn,je}function ta(){je=null}function ts(t){return Number.isFinite(t)}function sa(){const[t,s]=l.useState("0.60"),[n,a]=l.useState("300"),[r,o]=l.useState("640"),[i,c]=l.useState("0.80"),[d,u]=l.useState("1"),[m,h]=l.useState("30"),[p,x]=l.useState("90"),[f,g]=l.useState(null),[b,y]=l.useState(!0),[N,w]=l.useState(!1),[j,v]=l.useState(null),[k,P]=l.useState(null),T=l.useCallback(S=>{s(S.verification.threshold.toFixed(2)),a(String(S.cooldown.cooldownSec)),o(String(S.evidence.maxWidth)),c(S.evidence.jpegQuality.toFixed(2)),u(String(S.evidence.maxPerEvent)),h(String(S.retention.localDays)),x(String(S.retention.serverDays))},[]);l.useEffect(()=>{let S=!1;return(async()=>{y(!0);try{const R=await vs();if(S)return;g(R),T(R)}catch(R){S||v(R instanceof Error?R.message:"Failed to load policy config.")}finally{S||y(!1)}})(),()=>{S=!0}},[T]);const _=l.useCallback(async()=>{if(!f)return;const S=Number(t),L=Number(n),R=Number(r),E=Number(i),H=Number(d),F=Number(m),$=Number(p);if(!ts(S)||S<=0||S>1){v("Verification threshold must be between 0 and 1."),P(null);return}if(!Number.isInteger(L)||L<=0){v("Cooldown must be a positive integer."),P(null);return}if(!Number.isInteger(R)||R<240){v("Evidence max width must be an integer >= 240."),P(null);return}if(!ts(E)||E<=0||E>1){v("JPEG quality must be between 0 and 1."),P(null);return}if(!Number.isInteger(H)||H<=0){v("Max evidence per event must be a positive integer."),P(null);return}if(!Number.isInteger(F)||F<=0){v("Local retention days must be a positive integer."),P(null);return}if(!Number.isInteger($)||$<=0){v("Server retention days must be a positive integer."),P(null);return}w(!0),v(null),P(null);try{const D=await Xn({...f,verification:{threshold:S},cooldown:{cooldownSec:L},evidence:{maxWidth:R,jpegQuality:E,maxPerEvent:H},retention:{localDays:F,serverDays:$}});g(D),T(D),ta(),P("Policy saved to local database.")}catch(D){v(D instanceof Error?D.message:"Failed to save policy."),P(null)}finally{w(!1)}},[n,f,T,i,m,d,r,p,t]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Policy Settings"}),e.jsx("p",{className:"ui-text mt-1 text-sm",children:"Save policy to local DB. Verify flow reads the threshold from POLICY_CONFIG."}),b?e.jsx("p",{className:"ui-note mt-2",children:"Loading policy..."}):null,j?e.jsx("p",{className:"ui-note-error mt-2",children:j}):null,k?e.jsx("p",{className:"ui-note mt-2 text-emerald-700",children:k}):null]}),e.jsxs("section",{className:"ui-card p-4",children:[e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Verification Threshold",e.jsx("input",{value:t,onChange:S=>s(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Cooldown (sec)",e.jsx("input",{value:n,onChange:S=>a(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Evidence Max Width",e.jsx("input",{value:r,onChange:S=>o(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["JPEG Quality",e.jsx("input",{value:i,onChange:S=>c(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Max Evidence Per Event",e.jsx("input",{value:d,onChange:S=>u(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Local Retention Days",e.jsx("input",{value:m,onChange:S=>h(S.target.value),className:"ui-input"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Server Retention Days",e.jsx("input",{value:p,onChange:S=>x(S.target.value),className:"ui-input"})]})]}),e.jsx("button",{type:"button",onClick:()=>{_()},disabled:b||N||!f,className:"ui-btn ui-btn-primary mt-4 disabled:cursor-not-allowed disabled:opacity-60",children:N?"Saving...":"Save Policy"})]})]})}const na=[{id:"exp_001",at:"2026-02-12 09:10",status:"READY",rows:284},{id:"exp_002",at:"2026-02-11 18:02",status:"READY",rows:279}];function aa(){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Payroll CSV Export"}),e.jsx("p",{className:"ui-note mt-1",children:"Export includes action, timestamps, geo status, and evidence reference."}),e.jsx("button",{type:"button",className:"ui-btn ui-btn-success mt-4",children:"Generate New Export"})]}),e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h3",{className:"ui-title text-sm",children:"Recent Exports"}),e.jsx("ul",{className:"mt-3 space-y-2",children:na.map(t=>e.jsxs("li",{className:"ui-card-soft p-3",children:[e.jsx("p",{className:"text-xs font-mono text-slate-500",children:t.id}),e.jsxs("p",{className:"ui-note mt-1",children:[t.at," 路 ",t.rows," rows 路 ",t.status]})]},t.id))})]})]})}const ra=[{id:"aud_001",actor:"hr_admin",action:"EXPORT_CSV",target:"payroll_feb",at:"2026-02-12 09:12"},{id:"aud_002",actor:"hr_admin",action:"RESET_FACE",target:"staff_003",at:"2026-02-12 08:48"},{id:"aud_003",actor:"hr_admin",action:"UPDATE_POLICY",target:"cooldownSec",at:"2026-02-11 17:20"}];function oa(){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Audit Trail"}),e.jsx("p",{className:"ui-note mt-1",children:"Every admin-sensitive action is recorded for traceability."})]}),e.jsx("section",{className:"ui-card p-4",children:e.jsx("ul",{className:"space-y-2",children:ra.map(t=>e.jsxs("li",{className:"ui-card-soft p-3",children:[e.jsx("p",{className:"text-xs font-mono text-slate-500",children:t.id}),e.jsxs("p",{className:"ui-title mt-1 text-sm",children:[t.action," 路 ",t.target]}),e.jsxs("p",{className:"ui-note-xs",children:["Actor: ",t.actor," 路 ",t.at]})]},t.id))})})]})}function ss(){return typeof window>"u"?{pathname:"/",search:""}:{pathname:window.location.pathname,search:window.location.search}}function M(t,s=!1){if(typeof window>"u")return;const n=new URL(t,window.location.origin);(s?window.history.replaceState:window.history.pushState).call(window.history,null,"",`${n.pathname}${n.search}`),window.dispatchEvent(new PopStateEvent("popstate"))}const ia=["/admin/dashboard","/admin/logs","/admin/staff","/admin/settings","/admin/exports","/admin/audit"],kt="/admin/logs",la=new Set(ia);function ca(t){return la.has(t)?t:kt}function ns(){return typeof window>"u"?{route:kt,search:""}:{route:ca(window.location.pathname),search:window.location.search}}const da={"/admin/dashboard":"Dashboard","/admin/logs":"Attendance Logs","/admin/staff":"Staff","/admin/settings":"Settings","/admin/exports":"Exports","/admin/audit":"Audit Trail"},Ss="satts.admin.sidebar.collapsed";function ua(){return typeof window>"u"?!1:window.localStorage.getItem(Ss)==="1"}function ma({onLogout:t}){const[s,n]=l.useState(()=>ns()),[a,r]=l.useState(()=>ua()),[o,i]=l.useState([]),[c,d]=l.useState(!0),[u,m]=l.useState(null);l.useEffect(()=>{const g=()=>n(ns());return window.addEventListener("popstate",g),()=>window.removeEventListener("popstate",g)},[]),l.useEffect(()=>{window.location.pathname!==s.route&&M(s.route,!0)},[s.route]),l.useEffect(()=>{window.localStorage.setItem(Ss,a?"1":"0")},[a]);const h=l.useCallback(async()=>{d(!0);try{const g=await St(120);i(g),m(null)}catch(g){m(g instanceof Error?g.message:"Failed to load logs.")}finally{d(!1)}},[]);l.useEffect(()=>{h()},[h]);const p=s.route??kt,x=l.useMemo(()=>da[p],[p]),f=()=>{if(c&&p!=="/admin/settings")return e.jsx("section",{className:"ui-card p-4",children:e.jsx("p",{className:"ui-note",children:"Loading data..."})});if(u)return e.jsx("section",{className:"ui-card p-4",children:e.jsx("p",{className:"ui-note-error",children:u})});switch(p){case"/admin/dashboard":return e.jsx(Nn,{recentEvents:o});case"/admin/logs":return e.jsx(Zt,{recentEvents:o});case"/admin/staff":return e.jsx(qn,{});case"/admin/settings":return e.jsx(sa,{});case"/admin/exports":return e.jsx(aa,{});case"/admin/audit":return e.jsx(oa,{});default:return e.jsx(Zt,{recentEvents:o})}};return e.jsxs("div",{className:"flex min-h-screen bg-[var(--color-bg)] text-slate-900 transition-colors duration-300",children:[e.jsx(pn,{currentRoute:p,collapsed:a,onToggleCollapse:()=>r(g=>!g),onNavigate:g=>M(g),onSwitchToStaff:()=>M("/m/home")}),e.jsxs("div",{className:`flex flex-1 flex-col min-w-0 transition-all duration-300 ${a?"md:pl-[80px]":"md:pl-64"}`,children:[e.jsx(bn,{currentRoute:p,onNavigate:g=>M(g),onLogout:t}),e.jsx("main",{className:"flex-1 overflow-y-auto px-4 py-10 sm:px-8 md:px-12",children:e.jsxs("div",{className:"mx-auto max-w-7xl animate-in fade-in slide-in-from-bottom-2 duration-500",children:[e.jsxs("header",{className:"mb-10 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("nav",{className:"flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2",children:[e.jsx("span",{children:"Satts Central"}),e.jsx("span",{className:"text-slate-300",children:"/"}),e.jsx("span",{className:"text-sky-600",children:"Console"})]}),e.jsx("h1",{className:"ui-title text-4xl tracking-tight text-slate-900",children:x})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-emerald-500 animate-pulse"}),e.jsx("span",{className:"text-[10px] font-bold text-slate-500 uppercase tracking-tighter",children:"Live System"})]})]}),e.jsx("div",{className:"relative",children:f()})]})})]})]})}const ha=["/m/login","/m/change-password","/m/home","/m/verify","/m/result","/m/enroll/consent","/m/enroll/capture","/m/enroll/liveness","/m/history","/m/profile"],_t="/m/home",fa=new Set(ha);function xa(t){return fa.has(t)?t:_t}function as(){return typeof window>"u"?{route:_t,search:""}:{route:xa(window.location.pathname),search:window.location.search}}const Dt="satts.mobile.currentStaffId";function Lt(){return typeof window<"u"&&typeof window.localStorage<"u"}function Mt(t){return t.trim().toUpperCase()}function pa(){if(!Lt())return null;const t=window.localStorage.getItem(Dt);if(!t)return null;const s=Mt(t);return s.length>0?s:null}function De(t){Lt()&&window.localStorage.setItem(Dt,Mt(t))}function Ge(){Lt()&&window.localStorage.removeItem(Dt)}async function Pt(){const t=pa();if(t){const s=await se(t);return s&&s.status!=="LOCKED"?s:(Ge(),null)}return null}async function ga(t){const s=Mt(t);if(!/^[A-Z0-9_-]{3,32}$/.test(s))throw new Error("Invalid staff ID format.");const n=await se(s);if(!n)throw new Error(`Staff ID ${s} not found.`);if(n.status==="LOCKED")throw new Error(`Staff ${s} is locked. Contact admin.`);return De(n.staffId),n}const qe="satts.mobile.staff.session",ba=480*60*1e3;function Tt(){return typeof window<"u"&&typeof window.localStorage<"u"}function wa(t){try{const s=JSON.parse(t);return typeof s.staffId=="string"&&typeof s.name=="string"&&typeof s.mustChangePassword=="boolean"&&typeof s.issuedAt=="string"&&typeof s.expiresAt=="string"?{staffId:s.staffId,name:s.name,mustChangePassword:s.mustChangePassword,issuedAt:s.issuedAt,expiresAt:s.expiresAt}:null}catch{return null}}function Na(t){const s=Date.parse(t);return Number.isFinite(s)?Date.now()>=s:!0}function Es(t){Tt()&&window.localStorage.setItem(qe,JSON.stringify(t))}function Cs(t,s,n){const a=new Date;return{staffId:t.staffId,name:t.name,mustChangePassword:s,issuedAt:a.toISOString(),expiresAt:new Date(a.getTime()+n).toISOString()}}function bt(t,s,n=ba){const a=Cs(t,s,n);return Es(a),a}function Is(){if(!Tt())return null;const t=window.localStorage.getItem(qe);if(!t)return null;const s=wa(t);return!s||Na(s.expiresAt)?(window.localStorage.removeItem(qe),null):s}function As(){Tt()&&window.localStorage.removeItem(qe)}async function ya(){const t=Is();if(!t)return null;const s=await se(t.staffId);if(!s||s.status==="LOCKED")return As(),null;const n=s.credentials?.mustChangePassword??!0;if(s.name!==t.name||n!==t.mustChangePassword){const a=Math.max(1,Date.parse(t.expiresAt)-Date.now()),r=Cs({staffId:s.staffId,name:s.name},n,a);return Es(r),r}return t}function ja(t){const{refreshEnrollment:s,refreshRecentEvents:n,setAppError:a,setAppNotice:r,setStaffBound:o,setStaffId:i,setStaffName:c,setEnrollStatus:d,setDescriptorCount:u,setLastResult:m}=t,[h,p]=l.useState(()=>Is()),x=l.useCallback(async()=>{const w=await ya();if(p(w),w){De(w.staffId);return}Ge()},[]),f=l.useCallback(async w=>{const j=await Ct(w),v=j.credentials?.mustChangePassword??!0,k=bt({staffId:j.staffId,name:j.name},v);De(j.staffId),p(k),a(null),r(`Welcome ${j.name}.`),await Promise.all([n(),s()]),M(v?"/m/change-password":"/m/home",!0)},[s,n,a,r]),g=l.useCallback(async w=>{if(!h)throw new Error("Session expired. Please sign in again.");const j=await Un({staffId:h.staffId,currentPassword:w.currentPassword,newPassword:w.newPassword}),v=bt({staffId:j.staffId,name:j.name},!1);De(j.staffId),p(v),a(null),r("Password updated. Attendance features are now enabled."),await s(),M("/m/home",!0)},[s,a,r,h]),b=l.useCallback(()=>{As(),Ge(),p(null),o(!1),i(null),c(null),d("PENDING_CONSENT"),u(0),m(null),a(null),r("Signed out."),M("/login?role=staff",!0)},[a,r,u,d,m,o,i,c]),y=l.useCallback(async w=>{if(!h){a("Sign in is required before binding staff.");return}const j=w.trim().toUpperCase();if(j!==h.staffId){a("You can only bind the currently signed-in Staff ID.");return}try{const v=await ga(j);a(null),r(`Bound to ${v.staffId} (${v.name}).`),await s()}catch(v){a(v instanceof Error?v.message:"Failed to bind staff.")}},[s,a,r,h]),N=l.useCallback(async()=>{Ge(),d("PENDING_CONSENT"),u(0),o(!1),i(null),c(null),r("Staff binding cleared. Re-bind your own Staff ID."),await s()},[s,r,u,d,o,i,c]);return{staffSession:h,refreshSessionState:x,handleStaffLogin:f,handleStaffPasswordChange:g,handleStaffLogout:b,handleBindStaff:y,handleClearStaffBinding:N}}const va=[{route:"/m/home",label:"Dashboard",icon:t=>e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:t?2.5:2,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})})},{route:"/m/history",label:"Attendance History",icon:t=>e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:t?2.5:2,d:"M12 8v4l3 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"})})},{route:"/m/profile",label:"My Profile",icon:t=>e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:t?2.5:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}];function tt({currentRoute:t,staffName:s,onNavigate:n}){return e.jsxs("aside",{className:"fixed left-0 top-0 hidden h-screen w-64 flex-col border-r border-slate-200 bg-white lg:flex",children:[e.jsxs("div",{className:"flex h-20 items-center gap-3 px-6",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-600 text-white shadow-lg shadow-emerald-200/50",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-black uppercase tracking-widest text-slate-900",children:"Attendance"}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400",children:"Staff Workspace"})]})]}),e.jsx("nav",{className:"flex-1 space-y-1 px-4 py-6",children:va.map(a=>{const r=a.route===t;return e.jsxs("button",{onClick:()=>n(a.route),className:`group relative flex w-full items-center gap-3 rounded-xl px-4 py-3 text-sm font-bold transition-all ${r?"bg-slate-50 text-emerald-600":"text-slate-500 hover:bg-slate-50/50 hover:text-slate-700"}`,children:[r&&e.jsx("div",{className:"absolute left-0 h-5 w-1 rounded-r-full bg-emerald-600"}),e.jsx("div",{className:`${r?"text-emerald-600":"text-slate-400 group-hover:text-slate-500"}`,children:a.icon(r)}),a.label]},a.route)})}),e.jsx("div",{className:"border-t border-slate-100 p-6",children:e.jsxs("div",{className:"flex items-center gap-3 rounded-2xl bg-slate-50 p-3",children:[e.jsx("div",{className:"h-10 w-10 shrink-0 rounded-xl bg-slate-900 flex items-center justify-center text-white text-xs font-black",children:s?.substring(0,2).toUpperCase()||"ST"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-xs font-black text-slate-900",children:s||"Staff User"}),e.jsx("p",{className:"truncate text-[10px] font-bold text-slate-400",children:"Authenticated Member"})]})]})})]})}function ks({facingMode:t="user",className:s,videoClassName:n,showStatusText:a=!0,statusClassName:r,onReady:o,onError:i}){const c=l.useRef(null),d=l.useRef(null),u=l.useRef(o),m=l.useRef(i),[h,p]=l.useState(!1);return l.useEffect(()=>{u.current=o,m.current=i},[i,o]),l.useEffect(()=>{let x=!0;return(async()=>{if(!navigator.mediaDevices?.getUserMedia){m.current?.(new Error("This browser does not support camera access."));return}try{const g=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:t,width:{ideal:640},height:{ideal:480},frameRate:{ideal:24,max:30}}});if(!x){g.getTracks().forEach(b=>b.stop());return}if(d.current=g,!c.current||(c.current.srcObject=g,await c.current.play(),!x))return;p(!0),u.current?.(c.current)}catch(g){const b=g instanceof Error?g:new Error("Unable to access camera.");m.current?.(b)}})(),()=>{x=!1,d.current?.getTracks().forEach(g=>g.stop()),d.current=null,p(!1)}},[t]),e.jsxs("div",{className:s,children:[e.jsx("video",{ref:c,autoPlay:!0,muted:!0,playsInline:!0,className:n??"w-full rounded-xl bg-slate-950"}),a?e.jsx("p",{className:r??"mt-2 text-xs text-slate-600",children:h?"Camera ready":"Starting camera..."}):null]})}const Sa=[{indexes:Array.from({length:17},(t,s)=>s)},{indexes:[17,18,19,20,21]},{indexes:[22,23,24,25,26]},{indexes:[27,28,29,30]},{indexes:[31,32,33,34,35]},{indexes:[36,37,38,39,40,41],closePath:!0},{indexes:[42,43,44,45,46,47],closePath:!0},{indexes:[48,49,50,51,52,53,54,55,56,57,58,59],closePath:!0},{indexes:[60,61,62,63,64,65,66,67],closePath:!0}];function ct({valueX:t,valueY:s,sourceWidth:n,sourceHeight:a,renderWidth:r,renderHeight:o}){const i=Math.max(r/n,o/a),c=n*i,d=a*i,u=(r-c)/2,m=(o-d)/2;return{x:t*i+u,y:s*i+m,scale:i}}function Ea({videoElement:t,box:s,landmarks:n}){const a=l.useRef(null);return l.useEffect(()=>{const r=a.current;if(!r)return;const o=r.getContext("2d");if(!o)return;const i=r.clientWidth,c=r.clientHeight,d=window.devicePixelRatio||1;if(r.width=Math.floor(i*d),r.height=Math.floor(c*d),o.setTransform(d,0,0,d,0,0),o.clearRect(0,0,i,c),!t||!s)return;const u=t.videoWidth,m=t.videoHeight;if(!u||!m)return;const h=ct({valueX:s.x,valueY:s.y,sourceWidth:u,sourceHeight:m,renderWidth:i,renderHeight:c}),p=ct({valueX:s.x+s.width,valueY:s.y+s.height,sourceWidth:u,sourceHeight:m,renderWidth:i,renderHeight:c}),x=p.x-h.x,f=p.y-h.y,g=h.x+x/2,b=h.y+f/2;o.strokeStyle="rgba(16, 185, 129, 0.95)",o.lineWidth=2.4,o.shadowBlur=14,o.shadowColor="rgba(16, 185, 129, 0.6)",o.beginPath(),o.ellipse(g,b,Math.max(8,x/2),Math.max(10,f/2),0,0,Math.PI*2),o.stroke(),o.shadowBlur=0;const y=n.map(N=>ct({valueX:N.x,valueY:N.y,sourceWidth:u,sourceHeight:m,renderWidth:i,renderHeight:c}));o.strokeStyle="rgba(125, 211, 252, 0.85)",o.lineWidth=1.1;for(const N of Sa){const w=y[N.indexes[0]];if(w){o.beginPath(),o.moveTo(w.x,w.y);for(let j=1;j<N.indexes.length;j+=1){const v=y[N.indexes[j]];v&&o.lineTo(v.x,v.y)}N.closePath&&o.closePath(),o.stroke()}}o.fillStyle="rgba(16, 185, 129, 0.95)";for(const N of y)o.beginPath(),o.arc(N.x,N.y,1.5,0,Math.PI*2),o.fill()},[s,n,t]),e.jsx("canvas",{ref:a,className:"pointer-events-none absolute inset-0 z-10 h-full w-full"})}function Ca({modelReady:t,modelLoading:s,modelPercent:n,modelError:a,cameraError:r,videoElement:o,faceGuideBox:i,faceGuideLandmarks:c,onCameraReady:d,onCameraError:u}){return e.jsxs("section",{className:"absolute inset-0",children:[t?e.jsx(ks,{facingMode:"user",onReady:d,onError:u,className:"h-full w-full",videoClassName:"h-full w-full object-cover bg-slate-950",showStatusText:!1}):e.jsx("div",{className:"flex h-full w-full items-center justify-center bg-slate-950",children:e.jsxs("div",{className:"rounded-2xl border border-white/20 bg-black/45 px-4 py-3 text-center backdrop-blur-md",children:[e.jsx("div",{className:"mx-auto mb-2 h-5 w-5 animate-spin rounded-full border-2 border-white/35 border-t-white"}),e.jsx("p",{className:"text-xs font-semibold text-white",children:s?`Loading model ${Math.max(0,Math.min(100,n))}%`:"Preparing model..."}),e.jsx("p",{className:"mt-1 text-[11px] text-white/70",children:"Camera will start after model is ready."}),s?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mt-1.5 text-[11px] font-medium text-amber-200 opacity-0",style:{animation:"enroll-slow-hint 1ms linear 15s forwards"},children:"Network is slow. Please wait a moment, then retry if needed."}),e.jsx("style",{children:`
                  @keyframes enroll-slow-hint {
                    0% { opacity: 0; }
                    100% { opacity: 1; }
                  }
                `})]}):null]})}),e.jsx(Ea,{videoElement:o,box:i,landmarks:c}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-black/45 via-transparent to-black/65"}),a?e.jsx("p",{className:"absolute left-4 right-4 top-4 z-20 rounded-xl border border-red-300/40 bg-red-900/65 px-3 py-2 text-xs font-semibold text-red-100 backdrop-blur-md",children:a}):null,r?e.jsx("p",{className:"absolute left-4 right-4 top-16 z-20 rounded-xl border border-red-300/40 bg-red-900/65 px-3 py-2 text-xs font-semibold text-red-100 backdrop-blur-md",children:r}):null]})}function Ia({onBack:t}){return e.jsx("div",{className:"ui-page-flow",children:e.jsxs("main",{className:"ui-main-flow",children:[e.jsx("h1",{className:"ui-title text-xl",children:"Enrollment Capture"}),e.jsx("p",{className:"ui-note-warn mt-2",children:"Consent is required before capture. Returning to consent step."}),e.jsx("button",{type:"button",onClick:t,className:"ui-btn ui-btn-primary mt-4 w-full",children:"Back To Consent"})]})})}function Aa(t){return t.startsWith("data:")?t:`data:image/jpeg;base64,${t}`}function ka({photos:t,mode:s="card",onPreviewOpenChange:n}){const[a,r]=l.useState(null),[o,i]=l.useState(!1),c=l.useMemo(()=>t.map(f=>Aa(f)),[t]),d=a!==null&&a>=0&&a<c.length,u=d?c[a]:null,m=d&&a>0,h=d&&a<c.length-1,p=l.useCallback(()=>{r(f=>f===null?null:Math.max(0,f-1))},[]),x=l.useCallback(()=>{r(f=>f===null?null:Math.min(c.length-1,f+1))},[c.length]);return l.useEffect(()=>{if(a===null)return;const f=g=>{if(g.key==="Escape"){r(null);return}if(g.key==="ArrowLeft"){g.preventDefault(),p();return}g.key==="ArrowRight"&&(g.preventDefault(),x())};return window.addEventListener("keydown",f),()=>{window.removeEventListener("keydown",f)}},[x,p,a]),l.useEffect(()=>{n?.(u!==null)},[n,u]),e.jsxs(e.Fragment,{children:[s==="strip"?e.jsxs("section",{className:"rounded-xl border border-white/20 bg-black/40 p-2 backdrop-blur-md",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between",children:[e.jsx("h2",{className:"text-[10px] font-semibold uppercase tracking-wider text-white/80",children:"Captured Photos"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-semibold text-white/70",children:[c.length," saved"]}),e.jsx("button",{type:"button",onClick:()=>i(f=>{const g=!f;return g||r(null),g}),className:"rounded-md border border-white/25 bg-white/10 px-2 py-0.5 text-[10px] font-semibold text-white",children:o?"Hide":"Show"})]})]}),o?c.length===0?e.jsx("p",{className:"text-[11px] text-white/70",children:"No captured photo yet. Auto capture will fill this strip."}):e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:c.map((f,g)=>{const b=g===c.length-1;return e.jsxs("button",{type:"button",onClick:()=>r(g),className:`relative h-11 w-11 shrink-0 overflow-hidden rounded-lg border bg-slate-100 ${b?"border-emerald-400 ring-2 ring-emerald-300/60":"border-slate-300"}`,"aria-label":`Preview captured photo ${g+1}`,children:[e.jsx("img",{src:f,alt:`Captured ${g+1}`,className:"h-full w-full object-cover"}),e.jsx("span",{className:"absolute right-0.5 top-0.5 rounded bg-black/70 px-1 py-0.5 text-[9px] font-semibold text-white",children:g+1})]},`${g}-${f.slice(0,24)}`)})}):e.jsx("p",{className:"text-[11px] text-white/65",children:"Hidden by default. Tap Show to expand photos."})]}):e.jsxs("section",{className:"ui-card mt-4 p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h2",{className:"ui-kicker mb-0",children:"Captured Photos"}),e.jsxs("span",{className:"ui-note-xs",children:[c.length," saved"]})]}),c.length===0?e.jsx("p",{className:"ui-note-xs",children:"No captured photo yet. Auto capture will fill this grid."}):e.jsx("div",{className:"grid grid-cols-5 gap-2 sm:grid-cols-6",children:c.map((f,g)=>{const b=g===c.length-1;return e.jsxs("button",{type:"button",onClick:()=>r(g),className:`relative aspect-square overflow-hidden rounded-lg border bg-slate-100 ${b?"border-emerald-500 ring-2 ring-emerald-200":"border-slate-200"}`,"aria-label":`Preview captured photo ${g+1}`,children:[e.jsx("img",{src:f,alt:`Captured ${g+1}`,className:"h-full w-full object-cover"}),e.jsx("span",{className:"absolute right-1 top-1 rounded bg-black/65 px-1.5 py-0.5 text-[10px] font-semibold text-white",children:g+1})]},`${g}-${f.slice(0,24)}`)})})]}),u?e.jsxs("div",{className:"fixed inset-0 z-[90] bg-black/92",onClick:()=>r(null),role:"presentation",children:[e.jsxs("div",{className:"absolute inset-x-0 top-0 z-10 flex items-center justify-between px-4 pb-2 pt-[max(0.75rem,env(safe-area-inset-top))]",children:[e.jsxs("p",{className:"rounded-xl border border-white/20 bg-black/45 px-3 py-1 text-xs font-semibold text-white backdrop-blur-md",children:[d?a+1:0,"/",c.length]}),e.jsx("button",{type:"button",onClick:()=>r(null),className:"rounded-xl border border-white/25 bg-black/50 px-3 py-1 text-xs font-semibold text-white backdrop-blur-md",children:"Close"})]}),e.jsx("div",{className:"flex h-full w-full items-center justify-center px-2 pb-[max(1rem,env(safe-area-inset-bottom))] pt-14",onClick:f=>f.stopPropagation(),role:"dialog","aria-modal":"true",children:e.jsx("img",{src:u,alt:`Preview ${d?a+1:0}`,className:"max-h-full max-w-full rounded-lg bg-slate-950 object-contain"})}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2",children:e.jsx("button",{type:"button",onClick:f=>{f.stopPropagation(),p()},disabled:!m,className:"pointer-events-auto rounded-full border border-white/25 bg-black/50 px-3 py-2 text-xs font-semibold text-white backdrop-blur-md disabled:cursor-not-allowed disabled:opacity-40",children:"Prev"})}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2",children:e.jsx("button",{type:"button",onClick:f=>{f.stopPropagation(),x()},disabled:!h,className:"pointer-events-auto rounded-full border border-white/25 bg-black/50 px-3 py-2 text-xs font-semibold text-white backdrop-blur-md disabled:cursor-not-allowed disabled:opacity-40",children:"Next"})})]}):null]})}function _a({enabled:t,ready:s,intervalMs:n,onTick:a}){l.useEffect(()=>{if(!t||!s)return;let r=!1,o=null;const i=async()=>{r||(await a(),!r&&(o=window.setTimeout(()=>{i()},n)))};return o=window.setTimeout(()=>{i()},n),()=>{r=!0,o!==null&&window.clearTimeout(o)}},[t,n,a,s])}function Da(){const[t,s]=l.useState(0),[n,a]=l.useState(!1),[r,o]=l.useState(!0),[i,c]=l.useState(null);return l.useEffect(()=>{let d=!1;return(async()=>{o(!0),c(null);try{const{faceAPIService:m}=await q(async()=>{const{faceAPIService:h}=await Promise.resolve().then(()=>Oe);return{faceAPIService:h}},void 0);await m.loadModels("/models",h=>{d||s(h.percent)}),d||a(!0)}catch(m){if(d)return;const h=m instanceof Error?m.message:"Failed to load face model.";c(h)}finally{d||o(!1)}})(),()=>{d=!0}},[]),{modelPercent:t,modelReady:n,modelLoading:r,modelError:i}}class La{faceApi=null;runtimeReady=null;faceApiScriptPath="/vendor/face-api.js";tfWasmAssetPath="/vendor/";getRuntimeWindow(){return window}async loadScript(s){const n=document.querySelector(`script[data-satts-src="${s}"]`);if(n?.dataset.sattsReady!=="true"){if(n){await new Promise((a,r)=>{n.addEventListener("load",()=>a(),{once:!0}),n.addEventListener("error",()=>r(new Error(`Failed to load runtime script: ${s}`)),{once:!0})});return}await new Promise((a,r)=>{const o=document.createElement("script");o.src=s,o.async=!1,o.dataset.sattsSrc=s,o.addEventListener("load",()=>{o.dataset.sattsReady="true",a()},{once:!0}),o.addEventListener("error",()=>r(new Error(`Failed to load runtime script: ${s}`)),{once:!0}),document.head.appendChild(o)})}}async ensureRuntime(){return this.runtimeReady?this.runtimeReady:(this.runtimeReady=(async()=>{if(typeof window>"u")throw new Error("Face API models require browser runtime. Node mode can still use matchFace with pre-computed descriptors.");const s=this.getRuntimeWindow();if(s.faceapi||await this.loadScript(this.faceApiScriptPath),!s.faceapi)throw new Error("Face API runtime failed to initialize.");await this.configureBackend(s.faceapi.tf??s.tf),this.faceApi=s.faceapi})().catch(s=>{throw this.runtimeReady=null,s}),this.runtimeReady)}async getFaceApi(){if(this.faceApi||await this.ensureRuntime(),!this.faceApi)throw new Error("Face API runtime unavailable.");return this.faceApi}async preloadRuntime(){return await this.ensureRuntime(),this.getRuntimeState()}getRuntimeState(){const s=this.getRuntimeWindow(),n=s.faceapi?.tf?.getBackend?.()??s.tf?.getBackend?.()??null;return{ready:this.faceApi!==null,backend:n}}async configureBackend(s){if(!s?.setBackend||!s.ready)return;const n=["wasm","cpu"];for(const a of n)try{if(a==="wasm"&&s.wasm?.setWasmPaths(this.tfWasmAssetPath),!await s.setBackend(a))continue;await s.ready();return}catch(r){console.warn(`[SATTS][FaceRuntime] Failed to activate ${a} backend`,r)}}}const Ue=new La;function Ke(t){return t instanceof Float32Array?t:new Float32Array(t)}function Ma(t,s){if(t.length!==s.length)throw new Error("Descriptor length mismatch.");let n=0;for(let a=0;a<t.length;a+=1){const r=t[a]-s[a];n+=r*r}return Math.sqrt(n)}function Pa(t){return t.map(s=>({...s,descriptors:s.descriptors.map(n=>Ke(n)),meanDescriptor:s.meanDescriptor?Ke(s.meanDescriptor):void 0}))}function Ta(t,s,n){if(t.length===0)return{matched:!1,userId:null,name:null,distance:Number.POSITIVE_INFINITY,threshold:n};const a=Ke(s);let r=Number.POSITIVE_INFINITY,o=null;for(const c of t){const d=c.meanDescriptor?[c.meanDescriptor]:c.descriptors;for(const u of d){const m=Ma(a,Ke(u));m<r&&(r=m,o=c)}}const i=r<n;return{matched:i,userId:i&&o?o.id:null,name:i&&o?o.name??o.id:null,distance:r,threshold:n}}function rs(){return{stage:"recognition",status:"loaded",completed:3,total:3,percent:100,stageElapsedMs:null,totalElapsedMs:0}}async function Ra({faceApi:t,modelPath:s,detectorInputSize:n,detectorScoreThreshold:a,onProgress:r}){let i=0;const c=performance.now(),d=(p,x,f=null)=>{r?.({stage:p,status:x,completed:i,total:3,percent:Math.round(i/3*100),stageElapsedMs:f,totalElapsedMs:Math.round(performance.now()-c)})},u=performance.now();d("tiny","loading"),await t.nets.tinyFaceDetector.loadFromUri(s),i+=1,d("tiny","loaded",Math.round(performance.now()-u));const m=performance.now();d("landmark","loading"),await t.nets.faceLandmark68Net.loadFromUri(s),i+=1,d("landmark","loaded",Math.round(performance.now()-m));const h=performance.now();d("recognition","loading"),await t.nets.faceRecognitionNet.loadFromUri(s),i+=1,d("recognition","loaded",Math.round(performance.now()-h)),await Oa({faceApi:t,detectorInputSize:n,detectorScoreThreshold:a})}async function Oa({faceApi:t,detectorInputSize:s,detectorScoreThreshold:n}){const a=document.createElement("canvas");a.width=160,a.height=120;const r=a.getContext("2d");if(r){r.fillStyle="black",r.fillRect(0,0,a.width,a.height);try{await t.detectSingleFace(a,new t.TinyFaceDetectorOptions({inputSize:s,scoreThreshold:n})).withFaceLandmarks().withFaceDescriptor()}catch{}}}class de{static instance;modelPath="/models";modelsLoaded=!1;modelLoadPromise=null;matchThreshold=.6;detectorInputSize=320;detectorScoreThreshold=.5;registeredProfiles=[];constructor(){}static getInstance(){return de.instance||(de.instance=new de),de.instance}async loadModels(s="/models",n){if(this.modelsLoaded){n?.(rs());return}if(this.modelLoadPromise){await this.modelLoadPromise,n?.(rs());return}this.modelLoadPromise=this.loadModelsInternal(s,n).finally(()=>{this.modelLoadPromise=null}),await this.modelLoadPromise}async loadModelsInternal(s,n){const a=await Ue.getFaceApi();await Ra({faceApi:a,modelPath:s,detectorInputSize:this.detectorInputSize,detectorScoreThreshold:this.detectorScoreThreshold,onProgress:n}),this.modelPath=s,this.modelsLoaded=!0}async preloadRuntime(){return Ue.preloadRuntime()}getRuntimeState(){return Ue.getRuntimeState()}getModelState(){return{loaded:this.modelsLoaded,path:this.modelPath}}setProfiles(s){this.registeredProfiles=Pa(s)}setMatchThreshold(s){if(!Number.isFinite(s)||s<=0||s>1)throw new Error("Match threshold must be a finite number in (0, 1].");this.matchThreshold=s}async detectFace(s){if(!this.modelsLoaded)throw new Error("Face models are not loaded. Call loadModels() first.");const n=await Ue.getFaceApi(),a=await n.detectSingleFace(s,new n.TinyFaceDetectorOptions({inputSize:this.detectorInputSize,scoreThreshold:this.detectorScoreThreshold})).withFaceLandmarks().withFaceDescriptor();return a?{descriptor:a.descriptor,score:a.detection.score,box:{x:a.detection.box.x,y:a.detection.box.y,width:a.detection.box.width,height:a.detection.box.height},landmarks:a.landmarks.positions.map(r=>({x:r.x,y:r.y}))}:null}matchFace(s,n=this.matchThreshold){return Ta(this.registeredProfiles,s,n)}}const _s=de.getInstance(),Oe=Object.freeze(Object.defineProperty({__proto__:null,FaceAPIService:de,faceAPIService:_s},Symbol.toStringTag,{value:"Module"}));function We(t,s,n){return Math.max(s,Math.min(n,t))}function Fa(t){return t instanceof HTMLVideoElement?{width:t.videoWidth||t.clientWidth||0,height:t.videoHeight||t.clientHeight||0}:t instanceof HTMLImageElement?{width:t.naturalWidth||t.width||0,height:t.naturalHeight||t.height||0}:{width:t.width,height:t.height}}function $a(t,s,n=.14,a=160){const{width:r,height:o}=Fa(t);if(!r||!o)return null;const i=s.width*n,c=s.height*n,d=We(s.x-i,0,r),u=We(s.y-c,0,o),m=We(s.x+s.width+i,0,r),h=We(s.y+s.height+c,0,o),p=Math.max(1,m-d),x=Math.max(1,h-u),f=Math.min(1,a/Math.max(p,x)),g=Math.max(1,Math.round(p*f)),b=Math.max(1,Math.round(x*f)),y=document.createElement("canvas");y.width=g,y.height=b;const N=y.getContext("2d",{willReadFrequently:!0});return N?(N.drawImage(t,d,u,p,x,0,0,g,b),y):null}function Ba(t){const s=t.getContext("2d",{willReadFrequently:!0});if(!s)return 0;const n=t.width,a=t.height;if(n<3||a<3)return 0;const r=s.getImageData(0,0,n,a).data,o=new Float32Array(n*a);for(let b=0,y=0;b<r.length;b+=4,y+=1){const N=r[b],w=r[b+1],j=r[b+2];o[y]=.299*N+.587*w+.114*j}const i=new Float32Array(o.length);for(let b=0;b<a;b+=1){const y=b*n;for(let N=0;N<n;N+=1){const w=y+N;if(N===0||b===0||N===n-1||b===a-1){i[w]=o[w];continue}let j=0;for(let v=-1;v<=1;v+=1){const k=(b+v)*n;for(let P=-1;P<=1;P+=1)j+=o[k+N+P]}i[w]=j/9}}let c=0,d=0,u=0;const m=Math.max(1,Math.floor(n*.225)),h=Math.min(n-1,Math.ceil(n*.775)),p=Math.max(1,Math.floor(a*.225)),x=Math.min(a-1,Math.ceil(a*.775));for(let b=p;b<x;b+=1){const y=b*n;for(let N=m;N<h;N+=1){const w=y+N,j=i[w-n-1]+i[w-n]+i[w-n+1]+i[w-1]-8*i[w]+i[w+1]+i[w+n-1]+i[w+n]+i[w+n+1];c+=j,d+=j*j,u+=1}}if(u===0)return 0;const f=c/u,g=d/u-f*f;return Math.max(0,g)}function Ds(t,s){const n=$a(t,s);return n?Ba(n):null}const Ua=.12,Wa=.07,Ha=.5,Va=16,Ya=.72,Ga=.58,za=.18;function G(t,s,n){return Math.max(s,Math.min(n,t))}function Je(t,s){if(s.width<8||s.height<8)return null;const n=t.getImageData(s.x,s.y,s.width,s.height).data;if(n.length===0)return null;let a=0;const r=n.length/4;for(let o=0;o<n.length;o+=4){const i=n[o],c=n[o+1],d=n[o+2],u=.299*i+.587*c+.114*d,m=128-.168736*i-.331264*c+.5*d,h=128+.5*i-.418688*c-.081312*d;u>35&&m>=77&&m<=127&&h>=133&&h<=173&&(a+=1)}return a/Math.max(1,r)}function os(t,s){if(s.width<6||s.height<6)return null;const n=t.getImageData(s.x,s.y,s.width,s.height).data;if(n.length===0)return null;const a=[];for(let i=0;i<n.length;i+=4){const c=n[i],d=n[i+1],u=n[i+2];a.push(.299*c+.587*d+.114*u)}const r=a.reduce((i,c)=>i+c,0)/a.length,o=a.reduce((i,c)=>i+(c-r)**2,0)/a.length;return Math.sqrt(o)}function is(t){let s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const o of t)s=Math.min(s,o.x),n=Math.min(n,o.y),a=Math.max(a,o.x),r=Math.max(r,o.y);return{minX:s,minY:n,maxX:a,maxY:r}}function ls(t,s,n,a,r){const o=Math.max(1,t.maxX-t.minX),i=Math.max(1,t.maxY-t.minY),c=G(Math.round(t.minX-o*s),0,a-1),d=G(Math.round(t.minY-i*n),0,r-1),u=G(Math.round(t.maxX+o*s),c+1,a),m=G(Math.round(t.maxY+i*n),d+1,r);return{x:c,y:d,width:u-c,height:m-d}}function Ls(t){return t instanceof HTMLVideoElement?{width:t.videoWidth||t.clientWidth||0,height:t.videoHeight||t.clientHeight||0}:t instanceof HTMLImageElement?{width:t.naturalWidth||t.width||0,height:t.naturalHeight||t.height||0}:{width:t.width,height:t.height}}function qa(t,s){const{width:n,height:a}=Ls(t);if(!n||!a)return null;const r=G(Math.round(s.x),0,n-1),o=G(Math.round(s.y),0,a-1),i=G(Math.round(s.width),1,n-r),c=G(Math.round(s.height),1,a-o);if(i<40||c<40)return null;const d=document.createElement("canvas");d.width=n,d.height=a;const u=d.getContext("2d",{willReadFrequently:!0});if(!u)return null;u.drawImage(t,0,0,n,a);const m=r+Math.round(i*.2),h=Math.max(8,Math.round(i*.6)),p={x:G(m,0,n-8),y:G(o+Math.round(c*.24),0,a-8),width:G(h,8,n-m),height:G(Math.round(c*.2),8,a-o)},x={x:p.x,y:G(o+Math.round(c*.56),0,a-8),width:p.width,height:G(Math.round(c*.32),8,a-o)},f=Je(u,p),g=Je(u,x);if(f===null||g===null||f<Ua)return null;const b=g/Math.max(.001,f);return g<Wa&&b<Ha?`mask(upper:${f.toFixed(2)},lower:${g.toFixed(2)})`:null}function Ka(t,s){const{width:n,height:a}=Ls(t);if(!n||!a)return{blocked:!1,reason:null};const r=document.createElement("canvas");r.width=n,r.height=a;const o=r.getContext("2d",{willReadFrequently:!0});if(!o)return{blocked:!1,reason:null};o.drawImage(t,0,0,n,a);const i=is(s.slice(36,42)),c=is(s.slice(42,48)),d=ls(i,.45,.7,n,a),u=ls(c,.45,.7,n,a),m=os(o,d),h=os(o,u),p=Je(o,d),x=Je(o,u);if(m===null||h===null||p===null||x===null)return{blocked:!1,reason:null};const f=Math.min(m,h),g=Math.max(m,h),b=f/Math.max(.001,g),y=Math.max(p,x),N=Math.abs(p-x),w=f<Va&&b<Ya,j=y>Ga&&N>za;return w||j?{blocked:!0,reason:`eye_occlusion(std:${f.toFixed(1)},sym:${b.toFixed(2)},skin:${y.toFixed(2)},delta:${N.toFixed(2)})`}:{blocked:!1,reason:null}}const cs=.001,Ja=.1,Xa=.22,Qa=.68,Za=.72,er=.007,tr=.24,sr=.02,nr=.2,ar=.58,rr=.22,or=.09,ir=.74,lr=.0085,cr=.22;function dt(t){if(t.length<3)return 0;let s=0;for(let n=0;n<t.length;n+=1){const a=t[n],r=t[(n+1)%t.length];s+=a.x*r.y-r.x*a.y}return Math.abs(s)*.5}function He(t){const s=t.reduce((n,a)=>({x:n.x+a.x,y:n.y+a.y}),{x:0,y:0});return{x:s.x/t.length,y:s.y/t.length}}function te(t,s){const n=t.x-s.x,a=t.y-s.y;return Math.sqrt(n*n+a*a)}function Ms(t,s,n,a=1){if(s.length<68)return{blocked:!0,reason:"insufficient_landmarks"};const r=Math.max(1,t.width*t.height),o=dt(s.slice(36,42))/r,i=dt(s.slice(42,48))/r,c=te(s[36],s[39])/Math.max(1,t.width),d=te(s[42],s[45])/Math.max(1,t.width),u=dt(s.slice(48,60))/r,m=te(s[48],s[54])/Math.max(1,t.width),h=te(s[51],s[57])/Math.max(1,t.height),p=te(s[33],s[57])/Math.max(1,t.height),x=te(s[27],s[33])/Math.max(1,t.height),f=He(s.slice(36,42)),g=He(s.slice(42,48)),b=He(s.slice(48,60)),y=He([f,g]),N=s[8],w=te(f,g)/Math.max(1,t.width),j=(b.y-t.y)/Math.max(1,t.height),v=te(y,b)/Math.max(1,t.height),k=te(b,N)/Math.max(1,t.height),P=a<ir,T=P?lr:er,_=P?cr:nr,S=u<T||m<tr||h<sr||p<_||j<ar||v<rr||k<or,L=Math.min(o,i)/Math.max(1e-4,Math.max(o,i)),R=Math.min(c,d)/Math.max(1e-4,Math.max(c,d)),E=[];(o<cs||i<cs||L<Qa||R<Za)&&E.push("eyes");const H=n?Ka(n,s):null;H?.blocked&&H.reason&&E.push(H.reason),S&&E.push("mouth");const F=n?qa(n,t):null;F&&E.push(F),x<Ja&&E.push("nose"),w<Xa&&E.push("alignment");const $=E.includes("eyes")||E.includes("mouth")||E.some(D=>D.startsWith("eye_occlusion("))||E.some(D=>D.startsWith("mask("))||E.length>=2||E.includes("eyes")&&E.includes("nose");return{blocked:$,reason:$?E.join(","):null}}const Q=10,ds=600,dr=.55,ut=15,Rt=.58,ur=Rt*100,mt=7500,mr=3;function wt(t,s){if(t.length!==s.length)return Number.POSITIVE_INFINITY;let n=0;for(let a=0;a<t.length;a+=1){const r=t[a]-s[a];n+=r*r}return Math.sqrt(n)}function us(t){const s=t*100;return Math.max(0,Math.min(100,s))}function hr(t){const s=t.videoWidth,n=t.videoHeight;if(!s||!n)return null;const a=64,r=Math.max(1,Math.round(n/s*a)),o=document.createElement("canvas");o.width=a,o.height=r;const i=o.getContext("2d",{willReadFrequently:!0});if(!i)return null;i.drawImage(t,0,0,a,r);const c=i.getImageData(0,0,a,r).data;let d=0;const u=c.length/4;for(let m=0;m<c.length;m+=4){const h=c[m],p=c[m+1],x=c[m+2];d+=.2126*h+.7152*p+.0722*x}return u===0?null:d/u}function Xe(t){const s=fr(t.brightnessScore),n=xr(t.faceConfidence);return{brightnessScore:t.brightnessScore,lightLevel:s.level,lightMessage:s.message,faceConfidence:t.faceConfidence,distanceLevel:n.level,distanceMessage:n.message}}function Ps(t){return t==="CRITICAL"?mt*.6:t==="WARN"?mt*.8:mt}function ms(){return Xe({brightnessScore:null,faceConfidence:null})}function fr(t){return t===null?{level:"WARN",message:"Light: unavailable. Keep face in front of stable light source."}:t<45?{level:"CRITICAL",message:"Light: too dark. Move to brighter area or face window/light."}:t<70?{level:"WARN",message:"Light: low. Add light to reduce failed captures."}:{level:"GOOD",message:"Light: good."}}function xr(t){return t===null?{level:"CRITICAL",message:"Distance: face not found. Move closer and center your face."}:t<.45?{level:"CRITICAL",message:"Distance: likely too far. Move closer to camera."}:t<.62?{level:"WARN",message:"Distance: slightly far. Move a bit closer for stable capture."}:{level:"GOOD",message:"Distance: good."}}function pr(t){const s=t.videoWidth||640,n=t.videoHeight||480,a=480,r=s>a?a/s:1,o=Math.max(1,Math.round(s*r)),i=Math.max(1,Math.round(n*r)),c=document.createElement("canvas");c.width=o,c.height=i;const d=c.getContext("2d");if(!d)throw new Error("Unable to create image context for enrollment photo.");d.drawImage(t,0,0,o,i);const m=c.toDataURL("image/jpeg",.75).split(",")[1];if(!m)throw new Error("Failed to encode enrollment photo.");return m}function _e(t,s){t[s]=(t[s]??0)+1}function gr(t){let s=null,n=0;const a=Object.entries(t);for(const[r,o]of a)o>n&&(s=r,n=o);return s}function br(t){const s=t.naturalWidth||t.width,n=t.naturalHeight||t.height;if(!s||!n)return null;const a=64,r=Math.max(1,Math.round(n/s*a)),o=document.createElement("canvas");o.width=a,o.height=r;const i=o.getContext("2d",{willReadFrequently:!0});if(!i)return null;i.drawImage(t,0,0,a,r);const c=i.getImageData(0,0,a,r).data;let d=0;const u=c.length/4;for(let m=0;m<c.length;m+=4){const h=c[m],p=c[m+1],x=c[m+2];d+=.2126*h+.7152*p+.0722*x}return u===0?null:d/u}function wr(t){return new Promise((s,n)=>{const a=new Image;a.onload=()=>s(a),a.onerror=()=>n(new Error("decode_failed")),a.src=`data:image/jpeg;base64,${t}`})}function Nr(t){switch(t){case"decode_failed":return"剧瑙ｇ澶辫触";case"no_face":return"妫娴版浜鸿";case"occluded":return"浜瀹";case"blurry":return"婚㈡ā绯";case"mixed_identity":return"浼兼贩ヤ浜";default:return"璐ㄩ涓杈炬"}}async function yr(t){const s=Math.min(t.descriptors.length,t.photos.length),n=[],a=[],r={},o=[];let i=0;for(let m=0;m<s;m+=1){const h=t.descriptors[m],p=t.photos[m];let x;try{x=await wr(p)}catch{_e(r,"decode_failed");continue}const f=await _s.detectFace(x);if(!f){_e(r,"no_face");continue}if(Ms(f.box,f.landmarks,x,f.score).blocked){_e(r,"occluded");continue}const b=br(x),y=Xe({brightnessScore:b,faceConfidence:f.score}),N=Ps(y.lightLevel),w=Ds(x,f.box);if(w!==null){o.push(w),i=Math.max(i*.995,w);const j=[...o].sort((L,R)=>L-R),v=j[Math.floor((j.length-1)*.3)]??0,k=j[Math.floor((j.length-1)*.75)]??0,P=Math.max(i*.72,k*.64),T=Math.max(220,v*.55),_=i>0?Math.min(N,Math.max(T,P)):Math.min(N,1200);if(!(n.length===0&&o.length<8&&w>=180)&&w<_){_e(r,"blurry");continue}}if(n.length>0&&wt(n[0],h)>Rt){_e(r,"mixed_identity");continue}n.push(h),a.push(p)}const c=n.slice(0,Q),d=a.slice(0,Q),u=s-c.length;return{descriptors:c,photos:d,reviewedCount:s,removedCount:u,removedReasons:r,primaryReason:gr(r)}}async function jr(t){if(!(t.captureBusy||t.descriptors.length<Q)){t.onStart("姝ｅㄦц璐ㄩ澶妫锛璇风...");try{const s=await yr({descriptors:t.descriptors,photos:t.photos});if(s.descriptors.length<Q){t.onNeedRecapture({descriptors:s.descriptors,photos:s.photos,removedCount:s.removedCount,hint:`澶妫 ${s.removedCount} 寮寮甯稿抚锛涓昏锛${Nr(s.primaryReason)}锛锛璇疯ˉ ${Q} 寮`});return}t.onCompleted({descriptors:s.descriptors,photos:s.photos})}catch(s){const n=s instanceof Error?s.message:"Quality review failed.";t.onError(`璐ㄩ澶妫澶辫触锛${n}`)}finally{t.onFinally()}}}function vr({captureBusy:t,descriptors:s,photos:n,persistDraft:a,onCompleted:r,setCaptureBusy:o,setCaptureState:i,setCaptureHint:c,setDescriptors:d,setPhotos:u}){return l.useCallback(async()=>{await jr({descriptors:s,photos:n,captureBusy:t,onStart:m=>{o(!0),i("SCANNING"),c(m)},onNeedRecapture:({descriptors:m,photos:h,hint:p})=>{d(m),u(h),a(m,h),i("LOW_CONFIDENCE"),c(p)},onCompleted:({descriptors:m,photos:h})=>{a(m,h),r({descriptors:m,photos:h})},onError:m=>{i("LOW_CONFIDENCE"),c(m)},onFinally:()=>o(!1)})},[t,s,r,a,n,o,c,i,d,u])}const Ot="satts.mobile.enrollment.draft";function Ft(){return typeof window<"u"&&typeof window.localStorage<"u"}function ze(){return{consentAcceptedAt:null,descriptors:[],photos:[]}}function Sr(t){return Array.isArray(t)?t.map(s=>Array.isArray(s)?s.map(n=>Number(n)).filter(n=>Number.isFinite(n)):[]).filter(s=>s.length>0):[]}function Er(t){return Array.isArray(t)?t.map(s=>typeof s=="string"?s.trim():"").filter(s=>s.length>0):[]}function Ts(t){if(t===null||typeof t!="object")return ze();const s=t;return{consentAcceptedAt:typeof s.consentAcceptedAt=="string"&&s.consentAcceptedAt.trim().length>0?s.consentAcceptedAt:null,descriptors:Sr(s.descriptors),photos:Er(s.photos)}}function Rs(){if(!Ft())return ze();const t=window.localStorage.getItem(Ot);if(!t)return ze();try{return Ts(JSON.parse(t))}catch{return ze()}}function Os(t){if(!Ft())return;const s=Ts(t);window.localStorage.setItem(Ot,JSON.stringify(s))}function Nt(){Ft()&&window.localStorage.removeItem(Ot)}function Cr({consentAcceptedAt:t,initialDescriptors:s,initialPhotos:n,onBack:a,onReset:r,onCompleted:o}){const[i]=l.useState(()=>Rs()),c=t??i.consentAcceptedAt,{modelPercent:d,modelReady:u,modelLoading:m,modelError:h}=Da(),[p,x]=l.useState(!1),[f,g]=l.useState(null),[b,y]=l.useState(null),[N,w]=l.useState(()=>s.length>0?s:i.descriptors),[j,v]=l.useState(()=>n.length>0?n:i.photos),[k,P]=l.useState(!1),[T,_]=l.useState(!0),[S,L]=l.useState("SCANNING"),[R,E]=l.useState("Auto capture is running. Keep changing head angle."),[H,F]=l.useState("NORMAL"),[$,D]=l.useState(0),[V,B]=l.useState(null),[W,Z]=l.useState(null),[ae,C]=l.useState(()=>ms()),[U,ee]=l.useState(null),[Ee,J]=l.useState([]),re=l.useRef(0),A=l.useRef([]),O=l.useRef(0),oe=l.useRef([]),ie=l.useCallback((Y,le)=>{c&&Os({consentAcceptedAt:c,descriptors:Y,photos:le})},[c]);l.useEffect(()=>{c||a()},[c,a]);const fe=l.useCallback(async()=>{if(!(!b||!p||!u||k)&&!(N.length>=Q)){P(!0),L("SCANNING");try{const{faceAPIService:Y}=await q(async()=>{const{faceAPIService:K}=await Promise.resolve().then(()=>Oe);return{faceAPIService:K}},void 0),le=hr(b),z=await Y.detectFace(b);if(!z)throw ee(null),J([]),A.current=[],C(Xe({brightnessScore:le,faceConfidence:null})),new Error("No face detected. Keep face centered and retry.");ee(z.box),J(z.landmarks);const Vt=Xe({brightnessScore:le,faceConfidence:z.score});if(C(Vt),z.score<dr)throw L("LOW_CONFIDENCE"),new Error("Face confidence is low. Increase lighting and keep still.");if(Ms(z.box,z.landmarks,b,z.score).blocked){L("LOW_CONFIDENCE"),E("璇峰块＄肩/榧诲/村反锛淇瀹翠瀹瑙");return}const Yt=Ps(Vt.lightLevel),Ie=Ds(b,z.box);if(Ie!==null){const K=[...A.current,Ie];A.current=K.slice(-3);const X=[...oe.current,Ie];oe.current=X.slice(-48),O.current=Math.max(O.current*.995,Ie)}const ot=A.current,Ae=ot.length>0?ot.reduce((K,X)=>K+X,0)/ot.length:Ie,Gt=O.current,ge=[...oe.current].sort((K,X)=>K-X),Ks=ge.length?ge[Math.floor((ge.length-1)*.3)]:0,Js=ge.length?ge[Math.floor((ge.length-1)*.75)]:0,Xs=Math.max(Gt*.72,Js*.64),Qs=Math.max(220,Ks*.55),Zs=Gt>0?Math.min(Yt,Math.max(Qs,Xs)):Math.min(Yt,1200),en=N.length===0&&oe.current.length<8&&Ae!==null&&Ae>=180;if(B(Ae),!en&&Ae!==null&&Ae<Zs){F("BLURRY"),D(K=>{const X=K+1;if(X>=mr){const be=Date.now();be-re.current>=1400&&(typeof navigator<"u"&&"vibrate"in navigator&&navigator.vibrate(45),re.current=be)}return X}),L("BLURRY"),E("婚㈡ā绯锛璇蜂虹ǔ瀹骞剁寰椤裤");return}F("NORMAL"),D(0);const it=Array.from(z.descriptor);if(N.length>0){const K=wt(N[0],it);if(K>Rt){L("LOW_CONFIDENCE"),E(`浼奸涓浜猴anchor diff ${us(K).toFixed(2)}% > ${ur.toFixed(0)}%锛璇风卞涓浜虹户缁`);return}const X=Math.min(...N.map(sn=>wt(sn,it))),be=us(X);if(Z(be),be<ut){L("TOO_SIMILAR"),E(`Too similar (${be.toFixed(2)}%). Need >= ${ut}%. Change angle and retry.`);return}}const tn=pr(b),lt=[...N,it],zt=[...j,tn];w(lt),v(zt),ie(lt,zt),lt.length>=Q?(L("COMPLETED"),E("Capture complete. Continue to liveness challenge.")):(L("CAPTURED"),E("Captured. Switch pose and continue."))}catch(Y){const le=Y instanceof Error?Y.message:"Descriptor capture failed.";E(z=>z===le?z:le),S!=="BLURRY"&&L("LOW_CONFIDENCE")}finally{P(!1)}}},[p,k,S,N,u,ie,j,b]);_a({enabled:T&&N.length<Q,ready:!!(b&&p&&u),intervalMs:ds,onTick:fe});const rt=l.useCallback(Y=>{x(!0),g(null),y(Y)},[]),Fe=l.useCallback(Y=>{x(!1),g(Y.message)},[]),Ce=l.useCallback(()=>{_(Y=>!Y)},[]),I=l.useCallback(()=>{w([]),v([]),r(),ie([],[]),_(!0),L("SCANNING"),E("Capture reset. Auto capture resumed."),F("NORMAL"),D(0),B(null),A.current=[],O.current=0,oe.current=[],re.current=0,Z(null),C(ms()),ee(null),J([])},[r,ie]),xe=vr({captureBusy:k,descriptors:N,photos:j,persistDraft:ie,onCompleted:o,setCaptureBusy:P,setCaptureState:L,setCaptureHint:E,setDescriptors:w,setPhotos:v}),pe=Math.round(N.length/Q*100);return{hasConsent:!!c,modelPercent:d,modelReady:u,modelLoading:m,modelError:h,cameraReady:p,cameraError:f,videoElement:b,descriptors:N,photos:j,captureBusy:k,autoCaptureEnabled:T,captureState:S,captureHint:R,blurStatus:H,blurFrameStreak:$,lastSharpnessScore:V,lastMinDiffPercent:W,diagnostics:ae,faceGuideBox:U,faceGuideLandmarks:Ee,capturePercent:pe,captureTarget:Q,minDescriptorDiffPercent:ut,autoCaptureIntervalMs:ds,handleCameraReady:rt,handleCameraError:Fe,handleToggleAutoCapture:Ce,handleReset:I,handleContinue:xe}}function Ir(t){return t==="BLURRY"?"border-amber-300/40 bg-amber-400/20 text-amber-100":t==="TOO_SIMILAR"?"border-amber-300/35 bg-amber-400/15 text-amber-100":t==="LOW_CONFIDENCE"?"border-red-300/35 bg-red-400/15 text-red-100":t==="CAPTURED"?"border-emerald-300/35 bg-emerald-400/15 text-emerald-100":"border-white/25 bg-black/55 text-white"}function Ar(t){const s=Cr(t),[n,a]=l.useState(!1),r=l.useRef(!1),o=l.useRef(-1),i=s.hasConsent,c=s.descriptors.length,d=s.captureTarget,u=c>=d,m=s.handleContinue,h=s.autoCaptureEnabled,p=s.handleToggleAutoCapture;if(l.useEffect(()=>{if(n&&h){p(),r.current=!0;return}!n&&r.current&&!h&&(p(),r.current=!1)},[h,n,p]),l.useEffect(()=>{if(!(!i||n)){if(!u){o.current=-1;return}s.captureBusy||o.current!==c&&(o.current=c,m())}},[u,c,s.captureBusy,m,i,n]),!i)return e.jsx(Ia,{onBack:t.onBack});const x=s.captureState==="COMPLETED"?"CAPTURED":s.captureState;return e.jsxs("div",{className:"relative min-h-screen overflow-hidden bg-black",children:[e.jsx(Ca,{modelReady:s.modelReady,modelLoading:s.modelLoading,modelPercent:s.modelPercent,modelError:s.modelError,cameraError:s.cameraError,videoElement:s.videoElement,faceGuideBox:s.faceGuideBox,faceGuideLandmarks:s.faceGuideLandmarks,onCameraReady:s.handleCameraReady,onCameraError:s.handleCameraError}),c>0?e.jsx("div",{className:"pointer-events-none absolute inset-0 z-30 opacity-0",style:{animation:"enroll-shutter-flash 100ms ease-out"}},`shutter-${c}`):null,e.jsx("style",{children:`
        @keyframes enroll-shutter-flash {
          0% {
            opacity: 0.25;
            background-color: rgb(255 255 255);
          }
          100% {
            opacity: 0;
            background-color: rgb(255 255 255);
          }
        }
      `}),s.captureState==="BLURRY"&&s.blurFrameStreak>=3?e.jsx("div",{className:"pointer-events-none absolute left-1/2 top-[32%] z-40 -translate-x-1/2 rounded-xl border border-amber-200/40 bg-amber-500/20 px-3 py-1.5 text-xs font-semibold text-amber-100 backdrop-blur-sm",children:"婚㈡ā绯锛璇风ǔ瀹"}):null,e.jsxs("main",{className:"relative z-20 flex min-h-screen flex-col p-3 sm:p-5",children:[e.jsxs("header",{className:"pointer-events-auto flex items-center justify-between gap-3",children:[e.jsx("button",{type:"button",onClick:t.onBack,className:"rounded-xl border border-white/20 bg-black/55 px-3 py-1.5 text-xs font-semibold text-white backdrop-blur-md",children:"Back"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`rounded-2xl border px-3 py-1.5 text-xs font-semibold backdrop-blur-lg ${Ir(x)}`,children:x}),e.jsxs("div",{className:"rounded-2xl border border-white/25 bg-black/55 px-3 py-1.5 text-xs font-semibold text-white backdrop-blur-lg",children:[c,"/",d," 路 ",s.capturePercent,"%"]})]})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("section",{className:"pointer-events-auto w-full max-w-[22rem] space-y-1.5 self-center pb-[max(0.4rem,env(safe-area-inset-bottom))] sm:max-w-md",children:[e.jsxs("div",{className:"rounded-[22px] border border-white/25 bg-white/10 p-2.5 backdrop-blur-2xl shadow-[inset_0_1px_0_rgba(255,255,255,0.35)]",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",onClick:s.handleToggleAutoCapture,className:"rounded-xl border border-white/45 bg-white/15 px-2 py-1.5 text-xs font-semibold text-white backdrop-blur-xl shadow-[inset_0_1px_0_rgba(255,255,255,0.52)]",children:s.autoCaptureEnabled?"Pause":"Resume"}),e.jsx("button",{type:"button",onClick:s.handleReset,className:"rounded-xl border border-white/45 bg-white/15 px-2 py-1.5 text-xs font-semibold text-white backdrop-blur-xl shadow-[inset_0_1px_0_rgba(255,255,255,0.52)]",children:"Reset"})]}),e.jsxs("p",{className:"mt-1.5 text-[11px] font-medium text-white/85",children:["Min difference per capture: ",s.minDescriptorDiffPercent,"%.",s.lastMinDiffPercent!==null?` Last min difference: ${s.lastMinDiffPercent.toFixed(2)}%.`:""]}),e.jsxs("p",{className:`mt-1 text-[10px] font-semibold ${s.blurStatus==="BLURRY"?"text-amber-200":"text-emerald-200"}`,children:["澧锛",s.blurStatus==="BLURRY"?"妯＄":"姝ｅ父",s.lastSharpnessScore!==null?`锛Sharpness ${s.lastSharpnessScore.toFixed(1)}锛`:""]}),s.captureState==="BLURRY"?e.jsx("p",{className:"mt-1 text-[10px] font-semibold text-amber-100",children:s.captureHint}):null,u?e.jsx("p",{className:"mt-1 text-[10px] font-semibold text-emerald-200",children:s.captureBusy?"Target reached. Running quality recheck...":"Target reached. Preparing next step..."}):null]}),e.jsx(ka,{photos:s.photos,mode:"strip",onPreviewOpenChange:a})]})]})]})}const Fs="2026-02-12",kr="faceapi-v1",_r="org_01",Dr="office_hq_01";function Lr(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}async function $s(){const{pouchDBService:t}=await q(async()=>{const{pouchDBService:s}=await Promise.resolve().then(()=>ne);return{pouchDBService:s}},void 0);return t.init(),t.getDatabase()}function Bs(t){return`user::${t}`}function Mr(t){const s=t.map(n=>n.map(a=>Number(a)).filter(a=>Number.isFinite(a))).filter(n=>n.length>0);if(s.length===0)throw new Error("At least one valid descriptor is required for enrollment.");return s}function Pr(t){const s=t.map(a=>a.trim()).filter(a=>a.length>0);if(s.length===0)return;const n={};for(let a=0;a<s.length;a+=1){const r=`enroll_${String(a+1).padStart(2,"0")}.jpg`;n[r]={content_type:"image/jpeg",data:s[a]}}return n}async function $t(){const t=await Pt();if(!t)return null;const s=await $s();try{return await s.get(Bs(t.staffId))}catch(n){if(Lr(n))return null;throw n}}async function Tr(){const t=await Pt();if(!t)return{status:"PENDING_CONSENT",descriptorCount:0,consentAcceptedAt:null,staffBound:!1,staffId:null,staffName:null};const s=await $t();return s?{status:s.enrollStatus,descriptorCount:s.faceDescriptors.length,consentAcceptedAt:s.consent?.acceptedAt??null,staffBound:!0,staffId:t.staffId,staffName:t.name}:{status:"PENDING_CONSENT",descriptorCount:0,consentAcceptedAt:null,staffBound:!0,staffId:t.staffId,staffName:t.name}}async function Rr(t){const s=await Pt();if(!s)throw new Error("No staff is bound to this device. Bind a valid staff ID first.");const n=await $s(),a=await $t(),r=Mr(t.descriptors),o=Pr(t.photos),i={_id:Bs(s.staffId),_rev:a?._rev,type:"USER_PROFILE",orgId:_r,staffId:s.staffId,name:s.name,dept:s.dept,enrollStatus:"ACTIVE",descriptorVersion:kr,faceDescriptors:r,consent:{version:Fs,acceptedAt:t.consentAcceptedAt},settings:{allowedOfficeId:Dr},liveness:t.liveness,_attachments:o};return await n.put(i),await Ns(s.staffId,"ACTIVE"),i}function Or({onBack:t,onAccepted:s}){return e.jsx("div",{className:"ui-page-flow",children:e.jsxs("main",{className:"ui-main-flow",children:[e.jsx("button",{type:"button",onClick:t,className:"ui-back-btn",children:"Back"}),e.jsx("h1",{className:"ui-title text-xl",children:"Enrollment Consent"}),e.jsx("p",{className:"ui-note mt-1",children:"Read and accept before camera capture starts."}),e.jsxs("section",{className:"ui-card mt-4 p-4",children:[e.jsx("p",{className:"ui-kicker",children:"Consent Version"}),e.jsx("p",{className:"ui-title mt-1 text-sm",children:Fs}),e.jsxs("ul",{className:"mt-4 space-y-2 text-sm text-slate-700",children:[e.jsx("li",{children:"1. Device camera will be used for enrollment and attendance verification."}),e.jsx("li",{children:"2. The profile stores face descriptors and enrollment snapshots for audit traceability."}),e.jsx("li",{children:"3. You can request admin reset when profile changes are needed."})]})]}),e.jsx("button",{type:"button",onClick:()=>{const n=new Date().toISOString();Os({consentAcceptedAt:n,descriptors:[],photos:[]}),s(n)},className:"ui-btn ui-btn-primary mt-4 w-full",children:"I Agree, Continue"})]})})}const Fr=1;function $r({consentAcceptedAt:t,descriptors:s,photos:n,onBack:a,onRestart:r,onSaved:o}){const[i]=l.useState(()=>Rs()),c=t??i.consentAcceptedAt,d=s.length>0?s:i.descriptors,u=n.length>0?n:i.photos,[m,h]=l.useState(!1),[p,x]=l.useState(null),f=l.useCallback(async()=>{if(!c){x("Consent timestamp is missing. Restart enrollment.");return}if(d.length===0){x("No descriptors captured. Restart enrollment.");return}if(u.length===0){x("No enrollment photos captured. Restart enrollment.");return}h(!0),x(null);try{const b=new Date().toISOString(),y=await Rr({descriptors:d,photos:u,consentAcceptedAt:c,liveness:{mode:"PASSIVE_SCORE",passedAt:b,confidence:Fr}}),{faceAPIService:N}=await q(async()=>{const{faceAPIService:w}=await Promise.resolve().then(()=>Oe);return{faceAPIService:w}},void 0);N.setProfiles([{id:y.staffId,name:y.name,descriptors:y.faceDescriptors}]),Nt(),o(`Enrollment saved (${y.faceDescriptors.length} descriptors, ${u.length} photos).`)}catch(b){x(b instanceof Error?b.message:"Failed to save enrollment profile.")}finally{h(!1)}},[c,d,u,o]);if(!c||d.length===0||u.length===0)return e.jsx("div",{className:"ui-page-flow",children:e.jsxs("main",{className:"ui-main-flow",children:[e.jsx("h1",{className:"ui-title text-xl",children:"Review Your Enrollment"}),e.jsx("p",{className:"ui-note-warn mt-2",children:"Missing capture context. Restart from consent and capture steps."}),e.jsx("button",{type:"button",onClick:r,className:"ui-btn ui-btn-primary mt-4 w-full",children:"Restart Enrollment"})]})});const g=u[0];return e.jsxs("div",{className:"relative min-h-screen overflow-hidden bg-slate-950",children:[g?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:g,alt:"Enrollment background",className:"pointer-events-none absolute inset-0 h-full w-full scale-105 object-cover opacity-45 blur-2xl"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-black/55"})]}):e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900 to-black"}),e.jsxs("main",{className:"relative z-10 flex min-h-screen flex-col p-3 sm:p-5",children:[e.jsxs("header",{className:"pointer-events-auto flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:a,className:"rounded-xl border border-white/20 bg-black/55 px-3 py-1.5 text-xs font-semibold text-white backdrop-blur-md",children:"Back"}),e.jsx("div",{className:"rounded-2xl border border-white/25 bg-black/55 px-3 py-1.5 text-xs font-semibold text-white backdrop-blur-lg",children:"READY"})]}),e.jsxs("section",{className:"pointer-events-auto mt-4 rounded-3xl border border-white/20 bg-black/45 p-3 backdrop-blur-xl sm:p-4",children:[e.jsx("h1",{className:"text-lg font-black text-white sm:text-xl",children:"Review Your Enrollment"}),e.jsxs("p",{className:"mt-1 text-xs font-semibold text-white/75",children:[u.length," photos 路 ",d.length," descriptors 路 Ready to save"]}),e.jsx("div",{className:"mt-3 grid max-h-[55vh] grid-cols-4 gap-2 overflow-y-auto pr-1 sm:grid-cols-5",children:u.map((b,y)=>e.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-white/20 bg-slate-900",children:[e.jsx("img",{src:b,alt:`Captured ${y+1}`,className:"aspect-square w-full object-cover",loading:"lazy"}),e.jsx("span",{className:"absolute right-1 top-1 rounded-md bg-black/65 px-1.5 py-0.5 text-[10px] font-semibold text-white/90",children:y+1})]},`${y}-${b.slice(0,24)}`))})]}),e.jsx("div",{className:"flex-1"}),p?e.jsx("p",{className:"pointer-events-auto mb-2 rounded-xl border border-red-300/35 bg-red-900/60 px-3 py-2 text-xs font-semibold text-red-100 backdrop-blur-md",children:p}):null,e.jsxs("div",{className:"pointer-events-auto",children:[e.jsx("button",{type:"button",onClick:()=>{f()},disabled:m,className:"w-full rounded-2xl border border-emerald-300/50 bg-emerald-500 px-4 py-3 text-sm font-black text-white shadow-[0_12px_30px_rgba(16,185,129,0.45)] transition hover:bg-emerald-400 disabled:cursor-not-allowed disabled:border-emerald-900/40 disabled:bg-emerald-900/60",children:m?"Saving...":"纭璁ゅ苟瀹娉ㄥ"}),e.jsx("p",{className:"mt-2 text-center text-[11px] font-semibold text-white/75",children:"瑰诲灏 descriptor 涓х淇瀛版版版搴"})]})]})]})}const Br=[{route:"/m/home",label:"Home",iconName:"home"},{route:"/m/history",label:"History",iconName:"history"},{route:"/m/profile",label:"Profile",iconName:"profile"}];function st({currentRoute:t,onNavigate:s}){return e.jsx("nav",{className:"fixed inset-x-0 bottom-0 z-50 flex h-20 items-center justify-around border-t border-slate-100 bg-white/80 px-4 pb-safe backdrop-blur-xl lg:hidden",children:Br.map(n=>{const a=n.route===t;return e.jsxs("button",{type:"button",onClick:()=>s(n.route),className:`flex flex-col items-center gap-1 transition-all ${a?"text-slate-900":"text-slate-400 hover:text-slate-500"}`,children:[e.jsx("div",{className:`flex h-10 w-14 items-center justify-center rounded-2xl transition-all ${a?"bg-slate-900 text-white shadow-lg shadow-slate-200":"hover:bg-slate-50"}`,children:e.jsx(Ur,{name:n.iconName,active:a})}),e.jsx("span",{className:`text-[10px] font-extrabold uppercase tracking-widest ${a?"opacity-100":"opacity-60"}`,children:n.label})]},n.route)})})}function Ur({name:t,active:s}){const n=s?2.5:2;switch(t){case"home":return e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:n,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})});case"history":return e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:n,d:"M12 8v4l3 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"})});case"profile":return e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:n,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}}function Wr({currentRoute:t,staffName:s,events:n,onNavigate:a}){return e.jsxs("div",{className:"min-h-screen bg-slate-50/30",children:[e.jsx(tt,{currentRoute:t,staffName:s,onNavigate:a}),e.jsxs("main",{className:"mx-auto w-full max-w-7xl px-4 py-8 pb-32 sm:px-8 lg:pb-8 lg:pl-72",children:[e.jsxs("header",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-slate-900",children:"Attendance History"}),e.jsx("p",{className:"text-sm font-bold text-slate-400 mt-1",children:"Detailed logs of your workspace clock-ins and clock-outs."})]}),e.jsxs("section",{className:"ui-card bg-white p-0 overflow-hidden shadow-sm border-slate-100",children:[e.jsx("div",{className:"border-b border-slate-100 bg-slate-50/50 px-6 py-4 flex items-center justify-between",children:e.jsxs("h2",{className:"text-xs font-black uppercase tracking-widest text-slate-400",children:["Activity Log (",n.length,")"]})}),e.jsx("div",{className:"divide-y divide-slate-50",children:n.length>0?n.map(r=>e.jsxs("div",{className:"group flex items-center gap-6 p-6 hover:bg-slate-50/50 transition-colors",children:[e.jsx("div",{className:`flex h-12 w-12 shrink-0 items-center justify-center rounded-2xl font-black text-xs shadow-sm ${r.action==="IN"?"bg-emerald-100 text-emerald-700":"bg-blue-100 text-blue-700"}`,children:r.action}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"font-extrabold text-slate-900",children:r.action==="IN"?"Clocked In":"Clocked Out"}),e.jsx("span",{className:"text-[11px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg",children:new Date(r.clientTs).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs font-bold text-slate-400 uppercase tracking-tighter",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsxs("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor font-bold",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),r.geoStatus.replace(/_/g," ")]}),e.jsx(Me,{state:r.syncState})]})]})]},r.id)):e.jsx("div",{className:"py-20 text-center",children:e.jsx("p",{className:"text-sm font-bold text-slate-400 uppercase tracking-widest",children:"No history recorded yet"})})})]})]}),e.jsx(st,{currentRoute:t,onNavigate:a})]})}function Hr({disabled:t,onAction:s}){return e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsx("button",{type:"button",onClick:()=>s("IN"),disabled:t,className:"ui-btn ui-btn-success h-14 w-full rounded-xl text-base disabled:cursor-not-allowed disabled:opacity-50",children:"Time In"}),e.jsx("button",{type:"button",onClick:()=>s("OUT"),disabled:t,className:"ui-btn ui-btn-danger h-14 w-full rounded-xl text-base disabled:cursor-not-allowed disabled:opacity-50",children:"Time Out"})]})}function Vr({dbReady:t,online:s,syncState:n}){return e.jsx("div",{className:"ui-card p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ui-kicker",children:"Network"}),e.jsx("p",{className:`text-sm font-semibold ${s?"text-emerald-700":"text-amber-700"}`,children:s?"Online":"Offline"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"ui-kicker",children:"Local DB"}),e.jsx("p",{className:`text-sm font-semibold ${t?"text-emerald-700":"text-slate-600"}`,children:t?"Ready":"Initializing"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"ui-kicker mb-1",children:"Sync"}),e.jsx(Me,{state:n})]})]})})}const Yr=new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",month:"short",day:"2-digit"});function Gr({currentRoute:t,dbReady:s,enrollStatus:n,staffBound:a,staffName:r,online:o,latestSyncState:i,recentEvents:c,onAction:d,onStartEnrollment:u,onNavigate:m}){const h=!s||!a||n!=="ACTIVE",p=r??"Staff";return e.jsxs("div",{className:"min-h-screen bg-slate-50/30 font-sans",children:[e.jsx(tt,{currentRoute:t,staffName:r,onNavigate:m}),e.jsxs("main",{className:"mx-auto w-full max-w-7xl px-4 py-8 pb-32 sm:px-8 lg:pb-8 lg:pl-72",children:[e.jsxs("header",{className:"mb-10 flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("h1",{className:"text-3xl font-extrabold tracking-tight text-slate-900 sm:text-4xl",children:["Hello, ",e.jsx("span",{className:"text-emerald-600",children:p})]}),e.jsx("p",{className:"text-sm font-bold text-slate-400",children:"Ready to record your workspace attendance?"})]}),e.jsx("div",{className:"hidden lg:flex h-12 w-12 rounded-2xl bg-slate-900 items-center justify-center text-white text-xs font-black shadow-lg",children:p.substring(0,2).toUpperCase()})]}),e.jsx("section",{className:"mb-10",children:e.jsx(Vr,{dbReady:s,online:o,syncState:i})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8 items-start",children:[e.jsxs("div",{className:"lg:col-span-7 space-y-8",children:[e.jsxs("section",{className:"ui-card p-0",children:[e.jsxs("div",{className:"border-b border-slate-50 bg-slate-50/30 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-sm font-bold uppercase tracking-widest text-slate-400",children:"Workspace Console"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${h?"bg-amber-400":"bg-emerald-500 animate-pulse"}`}),e.jsx("span",{className:"text-[11px] font-bold text-slate-500",children:h?"Action Required":"Ready"})]})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx(Hr,{disabled:h,onAction:d})}),h&&e.jsx("div",{className:"rounded-2xl bg-gradient-to-br from-amber-50 to-orange-50 p-6 border border-amber-100/50 shadow-sm",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0 flex h-12 w-12 items-center justify-center rounded-2xl bg-amber-100 text-amber-600",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base font-bold text-amber-900 leading-tight",children:a?"Face Enrollment Missing":"Staff Binding Required"}),e.jsx("p",{className:"text-sm text-amber-700/80 mt-1 font-medium",children:a?"Please register your face profile to enable clock-in/out features.":"Bind a valid staff ID in Profile before enrollment and attendance."}),e.jsx("button",{type:"button",onClick:u,className:"mt-4 px-6 h-10 rounded-xl bg-amber-600 hover:bg-amber-700 text-white font-bold text-sm transition-all shadow-md hover:shadow-lg active:scale-95",children:"Setup Biometrics Now"})]})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"ui-card p-5 bg-emerald-50/30 border-emerald-100/50",children:[e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-wider text-emerald-600 mb-1",children:"Weekly Ratio"}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-2xl font-black text-emerald-900",children:"98%"}),e.jsx("span",{className:"text-xs font-bold text-emerald-600",children:"+2%"})]})]}),e.jsxs("div",{className:"ui-card p-5 bg-blue-50/30 border-blue-100/50",children:[e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-wider text-blue-600 mb-1",children:"Total Hours"}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-2xl font-black text-blue-900",children:"38.5"}),e.jsx("span",{className:"text-xs font-bold text-blue-600",children:"h"})]})]})]})]}),e.jsxs("section",{className:"lg:col-span-5 ui-card flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"border-b border-slate-50 bg-slate-50/30 px-6 py-4 flex justify-between items-center",children:[e.jsx("h2",{className:"text-sm font-bold uppercase tracking-widest text-slate-400",children:"Activity Log"}),e.jsx("button",{onClick:()=>m("/m/history"),className:"text-xs font-bold text-slate-900 hover:text-emerald-600 transition-colors py-1 px-3 rounded-lg hover:bg-slate-100",children:"View Analytics"})]}),e.jsx("div",{className:"p-6 flex-1",children:e.jsx("ul",{className:"space-y-6",children:c.length>0?c.slice(0,5).map(x=>e.jsxs("li",{className:"group relative flex gap-5 items-start",children:[e.jsx("div",{className:`relative z-10 flex h-11 w-11 shrink-0 items-center justify-center rounded-2xl font-bold text-xs shadow-sm transition-transform group-hover:scale-110 ${x.action==="IN"?"bg-emerald-100 text-emerald-700":"bg-blue-100 text-blue-700"}`,children:x.action}),e.jsxs("div",{className:"flex-1 min-w-0 border-b border-slate-50 pb-4 group-last:border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsx("p",{className:"text-sm font-extrabold text-slate-900",children:x.action==="IN"?"Clocked In":"Clocked Out"}),e.jsx("span",{className:"text-[10px] font-black tracking-tight text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full",children:Yr.format(new Date(x.clientTs))})]}),e.jsxs("p",{className:"text-xs font-semibold text-slate-500/80",children:[x.geoStatus.replace(/_/g," ")," 路 ",x.syncState.replace(/_/g," ")]})]})]},x.id)):e.jsxs("div",{className:"py-20 text-center space-y-3",children:[e.jsx("div",{className:"mx-auto h-12 w-12 rounded-full bg-slate-50 flex items-center justify-center",children:e.jsx("svg",{className:"h-6 w-6 text-slate-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("p",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest",children:"No Activity Yet"})]})})})]})]})]}),e.jsx(st,{currentRoute:t,onNavigate:m})]})}function zr({currentRoute:t,dbReady:s,enrollStatus:n,descriptorCount:a,staffBound:r,staffId:o,staffName:i,online:c,onStartEnrollment:d,onBindStaff:u,onClearStaffBinding:m,onLogout:h,onNavigate:p}){const[x,f]=l.useState(o??"");return e.jsxs("div",{className:"min-h-screen bg-slate-50/30 font-sans",children:[e.jsx(tt,{currentRoute:t,staffName:i,onNavigate:p}),e.jsxs("main",{className:"mx-auto w-full max-w-7xl px-4 py-8 pb-32 sm:px-8 lg:pb-8 lg:pl-72",children:[e.jsxs("header",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-slate-900",children:"User Profile"}),e.jsx("p",{className:"text-sm font-bold text-slate-400 mt-1",children:"Manage your identity binding and biometric enrollment."})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 items-start",children:[e.jsxs("section",{className:"ui-card bg-white p-0 overflow-hidden shadow-sm border-slate-100",children:[e.jsxs("div",{className:"border-b border-slate-100 bg-slate-50/50 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-slate-400",children:"Staff Identity"}),e.jsx("div",{className:`h-2.5 w-2.5 rounded-full ${r?"bg-emerald-500":"bg-amber-400 animate-pulse"}`})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-slate-400 block mb-1.5 ml-1",children:"Staff Identifier"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:x,onChange:g=>f(g.target.value.toUpperCase()),className:"bg-slate-50 border-slate-100 rounded-xl h-12 flex-1 px-4 text-sm font-bold text-slate-900 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-300",placeholder:"E.G. STAFF_001"}),e.jsx("button",{type:"button",onClick:()=>u(x),className:"bg-slate-900 hover:bg-slate-800 text-white px-6 rounded-xl font-bold text-sm shadow-md transition-all active:scale-95 whitespace-nowrap",children:"Bind Account"})]})]}),e.jsxs("div",{className:"pt-4 flex flex-col gap-2",children:[e.jsxs("p",{className:"text-xs font-bold text-slate-500 text-center",children:["Current Status: ",e.jsx("span",{className:r?"text-emerald-600":"text-amber-600",children:r?"Successfully Linked":"No Account Bound"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",onClick:m,className:"text-xs font-bold text-slate-400 hover:text-red-500 transition-colors py-2",children:"Remove Current Link"}),e.jsx("button",{type:"button",onClick:h,className:"text-xs font-bold text-slate-400 hover:text-amber-600 transition-colors py-2",children:"Logout"})]})]})]})})]}),e.jsxs("section",{className:"ui-card bg-white p-0 overflow-hidden shadow-sm border-slate-100",children:[e.jsx("div",{className:"border-b border-slate-100 bg-slate-50/50 px-6 py-4 flex items-center justify-between",children:e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-slate-400",children:"Enrollment & Diagnostics"})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 rounded-xl bg-slate-50 border border-slate-100",children:[e.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1",children:"Face Profile"}),e.jsx("p",{className:"text-lg font-black text-slate-900 leading-none",children:n})]}),e.jsxs("div",{className:`p-4 rounded-xl border ${c?"bg-emerald-50 border-emerald-100":"bg-slate-50 border-slate-100"}`,children:[e.jsx("p",{className:`text-[10px] font-black uppercase tracking-widest leading-none mb-1 ${c?"text-emerald-600":"text-slate-400"}`,children:"Network"}),e.jsx("p",{className:`text-lg font-black leading-none ${c?"text-emerald-900":"text-slate-900"}`,children:c?"Online":"Offline"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:d,disabled:!r,className:"w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-100 disabled:text-slate-400 text-white h-12 rounded-xl font-black text-sm shadow-lg shadow-emerald-200/50 transition-all active:scale-[0.98]",children:"Face Enrollment Setup"}),e.jsxs("div",{className:"flex items-center justify-between px-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:["Local Descriptors: ",a]}),e.jsxs("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:["Database: ",s?"READY":"BOOTING"]})]})]})]})]})]})]}),e.jsx(st,{currentRoute:t,onNavigate:p})]})}const ce="Retry Verify",qr={SUCCESS_RECORDED:{tone:"success",guidance:"Attendance has been saved locally and will sync automatically.",primaryAction:{label:"Go Home",path:"/m/home"},secondaryAction:{label:"View History",path:"/m/history"}},DUPLICATE_IGNORED:{tone:"warning",guidance:"Same request was already saved. Duplicate action was ignored safely.",primaryAction:{label:"Go Home",path:"/m/home"},secondaryAction:{label:"View History",path:"/m/history"}},COOLDOWN_ACTIVE:{tone:"warning",guidance:"Cooldown is active for this action. Please retry after remaining seconds.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},NO_FACE_DETECTED:{tone:"error",guidance:"Keep your face centered and retry with stable lighting.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},MODEL_LOAD_FAILED:{tone:"error",guidance:"Face model did not load completely. Retry after network is stable.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},CAMERA_UNAVAILABLE:{tone:"error",guidance:"Camera access failed. Check browser permission and retry.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},EVIDENCE_CAPTURE_FAILED:{tone:"error",guidance:"Evidence generation failed. Retry once to regenerate watermark image.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},PERSIST_FAILED:{tone:"error",guidance:"Local save failed. Check storage availability and retry.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}},VERIFICATION_FAILED:{tone:"error",guidance:"Verification failed. Retry and ensure camera + permissions are available.",primaryAction:{label:ce,path:"/m/home"},secondaryAction:{label:"Back Home",path:"/m/home"}}};function Kr(t,s){return t!=="/m/home"?t:`/m/verify?action=${s}`}function Jr(t){const s=qr[t.reasonCode],n=t.success?"Attendance Success":"Attendance Failed";return t.reasonCode==="COOLDOWN_ACTIVE"||t.reasonCode==="NO_FACE_DETECTED"||t.reasonCode==="MODEL_LOAD_FAILED"||t.reasonCode==="CAMERA_UNAVAILABLE"||t.reasonCode==="EVIDENCE_CAPTURE_FAILED"||t.reasonCode==="PERSIST_FAILED"||t.reasonCode==="VERIFICATION_FAILED"?{...s,title:n,primaryAction:{...s.primaryAction,path:Kr(s.primaryAction.path,t.action)}}:{...s,title:n}}const Xr={success:"text-emerald-700",warning:"text-amber-700",error:"text-rose-700"};function Qr({currentRoute:t,result:s,onNavigatePath:n,onNavigate:a}){const r=s?Jr(s):null;return e.jsxs("div",{className:"ui-page-mobile",children:[e.jsxs("main",{className:"ui-main-mobile",children:[e.jsx("h1",{className:"ui-title text-xl",children:"Attendance Result"}),e.jsx("p",{className:"ui-note mt-1",children:"Status code mapped recovery guidance."}),e.jsx("section",{className:"ui-card mt-4 p-4 md:max-w-2xl",children:s&&r?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:`text-base font-semibold ${Xr[r.tone]}`,children:r.title}),e.jsx("p",{className:"mt-2 text-sm text-slate-700",children:s.message}),e.jsx("p",{className:"ui-note-xs mt-2",children:r.guidance}),e.jsxs("ul",{className:"ui-note-xs mt-3 space-y-1",children:[e.jsxs("li",{children:["Action: ",s.action]}),e.jsxs("li",{children:["ClientTs: ",new Date(s.clientTs).toLocaleString()]}),e.jsxs("li",{children:["Geo: ",s.geoStatus]}),e.jsxs("li",{children:["Reason: ",s.reasonCode]}),e.jsxs("li",{children:["Sync: ",e.jsx(Me,{state:s.syncState})]})]})]}):e.jsx("p",{className:"ui-note",children:"No result yet. Start from Home."})}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 md:max-w-2xl",children:[e.jsx("button",{type:"button",onClick:()=>n(r?r.primaryAction.path:"/m/home"),className:"ui-btn ui-btn-primary",children:r?r.primaryAction.label:"Go Home"}),e.jsx("button",{type:"button",onClick:()=>n(r?r.secondaryAction.path:"/m/history"),className:"ui-btn ui-btn-ghost",children:r?r.secondaryAction.label:"View History"})]})]}),e.jsx(st,{currentRoute:t,onNavigate:a})]})}const Us=300;function yt(t){const s=Date.parse(t);return Number.isNaN(s)?0:s}function Zr(t,s){const n=s.filter(a=>a.action===t).sort((a,r)=>yt(r.clientTs)-yt(a.clientTs));return n.length>0?n[0]:null}async function eo(t,s=Us){const n=await St(50),a=Zr(t,n);if(!a)return{allowed:!0,remainingSec:0,lastEvent:null};const r=Date.now(),o=yt(a.clientTs),i=Math.floor((r-o)/1e3);return i>=s?{allowed:!0,remainingSec:0,lastEvent:a}:{allowed:!1,remainingSec:s-Math.max(i,0),lastEvent:a}}class to{activeKeys=new Set;acquire(s){return this.activeKeys.has(s)?!1:(this.activeKeys.add(s),!0)}release(s){this.activeKeys.delete(s)}}const hs=new to,fs="satts_device_id";function so(){if(typeof window>"u")return"dev_server";const t=window.localStorage.getItem(fs);if(t)return t;const s=`dev_${crypto.randomUUID().slice(0,8)}`;return window.localStorage.setItem(fs,s),s}const Le={maxWidth:640,jpegQuality:.8,minJpegQuality:.5,maxBytes:200*1024};function jt(t){return Number.isFinite(t)?Math.min(.95,Math.max(.4,t)):Le.jpegQuality}function xs(t,s){return new Promise((n,a)=>{t.toBlob(r=>{if(!r){a(new Error("Failed to encode evidence image."));return}n(r)},"image/jpeg",s)})}function no(t){return new Promise((s,n)=>{const a=new FileReader;a.onloadend=()=>{const r=a.result;if(typeof r!="string"){n(new Error("Failed to convert evidence to base64."));return}const[,o]=r.split(",");if(!o){n(new Error("Invalid evidence base64 payload."));return}s(o)},a.onerror=()=>n(new Error("Unable to read evidence image.")),a.readAsDataURL(t)})}function ao(t){const s=t.lat!==null&&t.lng!==null?`GPS ${t.lat.toFixed(5)},${t.lng.toFixed(5)} 卤${Math.round(t.accuracyM??0)}m`:"GPS unavailable";return[`TS ${t.clientTs}`,s,`Office ${t.officeName}`,`Device ${t.deviceId}`]}function ro(t,s,n){const a=ao(n),r=Math.max(10,Math.round(t.width/52)),o=Math.round(r*1.3),i=8,c=8;s.save(),s.font=`${r}px ui-monospace, SFMono-Regular, Menlo, monospace`,s.textBaseline="top";const d=a.reduce((x,f)=>{const g=s.measureText(f).width;return Math.max(x,g)},0),u=Math.ceil(d+i*2),m=Math.ceil(a.length*o+i*2),h=Math.max(c,t.width-u-c),p=c;s.fillStyle="rgba(15, 23, 42, 0.72)",s.fillRect(h,p,u,m),s.fillStyle="rgba(248, 250, 252, 0.96)",a.forEach((x,f)=>{s.fillText(x,h+i,p+i+o*f)}),s.restore()}function oo(t,s){if(t.videoWidth<=0||t.videoHeight<=0)throw new Error("Video stream is not ready for evidence capture.");const n=t.videoWidth,a=t.videoHeight,r=s>0?Math.min(1,s/n):1,o=Math.max(160,Math.round(n*r)),i=Math.max(120,Math.round(a*r)),c=document.createElement("canvas");c.width=o,c.height=i;const d=c.getContext("2d");if(!d)throw new Error("Canvas context is unavailable for evidence capture.");return d.drawImage(t,0,0,o,i),c}async function io(t,s){const n=jt(s.minJpegQuality);let a=jt(s.jpegQuality),r=await xs(t,a);for(;r.size>s.maxBytes&&a>n;)a=Math.max(n,Number((a-.1).toFixed(2))),r=await xs(t,a);return{blob:r,quality:a}}async function lo(t,s,n=Le){let a=n.maxWidth,r=null,o=jt(n.jpegQuality),i=null;for(let d=0;d<4;d+=1){const u=oo(t,a),m=u.getContext("2d");if(!m)throw new Error("Canvas context is unavailable for evidence watermark.");ro(u,m,s);const h=await io(u,n);if(r=h.blob,o=h.quality,i=u,h.blob.size<=n.maxBytes||a<=240)break;a=Math.max(240,Math.round(a*.85))}if(!r||!i)throw new Error("Evidence capture failed unexpectedly.");return{attachment:{content_type:"image/jpeg",data:await no(r)},bytes:r.size,quality:o,width:i.width,height:i.height}}const Ws={lat:1.3521,lng:103.8198,radiusM:120};function Ve(t){return t*Math.PI/180}function co(t,s,n,a){const o=Ve(n-t),i=Ve(a-s),c=Ve(t),d=Ve(n),u=Math.sin(o/2)*Math.sin(o/2)+Math.sin(i/2)*Math.sin(i/2)*Math.cos(c)*Math.cos(d);return 2*6371e3*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))}function uo(t,s,n){const a=Math.round(co(t,s,n.lat,n.lng));return{status:a<=n.radiusM?"IN_RANGE":"OUT_OF_RANGE",distanceM:a}}function mo(t=Ws){return new Promise(s=>{if(!navigator.geolocation){s({status:"LOCATION_UNAVAILABLE",lat:null,lng:null,accuracyM:null,distanceM:null});return}navigator.geolocation.getCurrentPosition(n=>{const{latitude:a,longitude:r,accuracy:o}=n.coords,i=uo(a,r,t);s({status:i.status,lat:a,lng:r,accuracyM:o,distanceM:i.distanceM})},()=>{s({status:"LOCATION_UNAVAILABLE",lat:null,lng:null,accuracyM:null,distanceM:null})},{enableHighAccuracy:!1,timeout:5e3,maximumAge:1e4})})}function ps(t,s){return{success:!1,action:t,clientTs:new Date().toISOString(),geoStatus:"LOCATION_UNAVAILABLE",syncState:"FAILED",reasonCode:"VERIFICATION_FAILED",message:s}}async function ho(t,s){const{faceAPIService:n}=await q(async()=>{const{faceAPIService:c}=await Promise.resolve().then(()=>Oe);return{faceAPIService:c}},void 0),a=await ea(),r=await $t();if(!r||r.enrollStatus!=="ACTIVE"||r.faceDescriptors.length===0)return{ok:!1,result:ps(t,"No active enrollment profile. Please complete face registration first.")};n.setProfiles([{id:r.staffId,name:r.name,descriptors:r.faceDescriptors}]);const o=await n.detectFace(s);if(!o)return{ok:!1,result:{success:!1,action:t,clientTs:new Date().toISOString(),geoStatus:"LOCATION_UNAVAILABLE",syncState:"FAILED",reasonCode:"NO_FACE_DETECTED",message:"No face detected. Please align face and retry."}};const i=n.matchFace(o.descriptor,a);return i.matched?{ok:!0,detection:o,staffId:r.staffId}:{ok:!1,result:ps(t,`Face mismatch. Distance ${i.distance.toFixed(3)} exceeds threshold ${i.threshold.toFixed(3)}.`)}}function fo(t){const s=t.toLowerCase();return s.includes("no face detected")?"NO_FACE_DETECTED":s.includes("model")?"MODEL_LOAD_FAILED":s.includes("camera")?"CAMERA_UNAVAILABLE":s.includes("evidence")?"EVIDENCE_CAPTURE_FAILED":s.includes("database")||s.includes("indexeddb")||s.includes("pouch")?"PERSIST_FAILED":"VERIFICATION_FAILED"}function xo({action:t,onBack:s,onCompleted:n}){const[a,r]=l.useState(0),[o,i]=l.useState(!1),[c,d]=l.useState(!0),[u,m]=l.useState(null),[h,p]=l.useState(!1),[x,f]=l.useState(null),[g,b]=l.useState(null),[y,N]=l.useState(!1),[w,j]=l.useState("Preparing camera and model..."),[v,k]=l.useState(null);l.useEffect(()=>{let _=!1;return(async()=>{d(!0),m(null);try{const{faceAPIService:L}=await q(async()=>{const{faceAPIService:R}=await Promise.resolve().then(()=>Oe);return{faceAPIService:R}},void 0);if(await L.loadModels("/models",R=>{_||r(R.percent)}),_)return;i(!0),j("Face model ready. You can verify now.")}catch(L){if(_)return;const R=L instanceof Error?L.message:"Failed to load face model.";m(R),j("Model load failed. Please retry.")}finally{_||d(!1)}})(),()=>{_=!0}},[]);const P=l.useCallback(async()=>{if(!(!g||!h||!o)&&hs.acquire(t)){N(!0),k(null),j("Verifying face and creating local event...");try{const _=await eo(t,Us);if(!_.allowed){k(`Cooldown active. Retry in ${_.remainingSec}s (${t}).`),n({success:!1,action:t,clientTs:new Date().toISOString(),geoStatus:_.lastEvent?.geoStatus??"LOCATION_UNAVAILABLE",syncState:"FAILED",reasonCode:"COOLDOWN_ACTIVE",message:`Cooldown active. Please wait ${_.remainingSec}s.`});return}j("Verifying face against enrollment profile...");const S=await ho(t,g);if(!S.ok){n(S.result);return}const{detection:L,staffId:R}=S;j("Capturing geolocation...");const E=await mo(),H=crypto.randomUUID(),F=new Date().toISOString(),$="LOCAL_ONLY",D=so();j("Generating evidence watermark...");const V=await lo(g,{clientTs:F,lat:E.lat,lng:E.lng,accuracyM:E.accuracyM,officeName:"HQ",deviceId:D},Le),B=dn({eventId:H,staffId:R,action:t,clientTs:F,syncState:$,verifyScore:L.score,deviceId:D,geoStatus:E.status,distanceM:E.distanceM,lat:E.lat,lng:E.lng,accuracyM:E.accuracyM,evidenceAttachment:V.attachment});if((await hn(B)).status==="DUPLICATE"){n({success:!0,action:t,clientTs:F,geoStatus:E.status,syncState:$,reasonCode:"DUPLICATE_IGNORED",message:`${t==="IN"?"Time In":"Time Out"} duplicate request ignored.`});return}n({success:!0,action:t,clientTs:F,geoStatus:E.status,syncState:$,reasonCode:"SUCCESS_RECORDED",message:`${t==="IN"?"Time In":"Time Out"} recorded locally with evidence (${Math.round(V.bytes/1024)}KB).`})}catch(_){const S=_ instanceof Error?_.message:"Verification failed.";n({success:!1,action:t,clientTs:new Date().toISOString(),geoStatus:"LOCATION_UNAVAILABLE",syncState:"FAILED",reasonCode:fo(S),message:S})}finally{N(!1),hs.release(t)}}},[t,h,o,n,g]),T=l.useMemo(()=>!h||!o||y||c,[h,y,c,o]);return e.jsx("div",{className:"ui-page-flow",children:e.jsxs("main",{className:"ui-main-flow",children:[e.jsx("button",{type:"button",onClick:s,className:"ui-back-btn",children:"Back"}),e.jsxs("h1",{className:"ui-title text-xl",children:["Verify ",t==="IN"?"Time In":"Time Out"]}),e.jsx("p",{className:"ui-note mt-1",children:w}),e.jsxs("section",{className:"ui-card mt-4 p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between text-xs font-medium",children:[e.jsx("span",{className:"ui-note-xs",children:"Model"}),e.jsx("span",{className:o?"ui-status-ok":"ui-status-pending",children:o?"Ready":c?`${a}%`:"Pending"})]}),e.jsx("div",{className:"ui-progress-track",children:e.jsx("div",{className:"ui-progress-bar",style:{width:`${o?100:a}%`}})}),u?e.jsx("p",{className:"ui-note-error mt-2",children:u}):null]}),e.jsxs("section",{className:"ui-card mt-4 p-4",children:[e.jsx(ks,{facingMode:"user",onReady:_=>{p(!0),f(null),b(_)},onError:_=>{p(!1),f(_.message),j("Camera error. Check permission and retry.")}}),x?e.jsx("p",{className:"ui-note-error mt-2",children:x}):null,v?e.jsx("p",{className:"ui-note-warn mt-2",children:v}):null,e.jsx("button",{type:"button",onClick:()=>{P()},disabled:T,className:"ui-btn ui-btn-primary mt-3 w-full disabled:cursor-not-allowed disabled:bg-slate-400",children:y?"Verifying...":"Verify And Save"}),e.jsxs("p",{className:"ui-note-xs mt-2",children:["Geofence policy: ",Ws.radiusM,"m"]}),e.jsxs("p",{className:"ui-note-xs",children:["Evidence policy: max ",Math.round(Le.maxBytes/1024),"KB, q",Le.jpegQuality.toFixed(1)]})]})]})})}function ht({staffName:t,onNavigate:s,fullBleed:n=!1,children:a}){return e.jsxs("div",{className:n?"min-h-screen bg-black font-sans":"min-h-screen bg-slate-50/30 font-sans",children:[e.jsx(tt,{currentRoute:"/m/profile",staffName:t,onNavigate:s}),e.jsx("div",{className:n?"w-full lg:pl-72":"mx-auto w-full max-w-7xl px-4 py-6 sm:px-8 lg:pl-72 lg:py-8",children:a})]})}function po({currentRoute:t,dbReady:s,enrollStatus:n,descriptorCount:a,staffBound:r,staffId:o,staffName:i,online:c,latestSyncState:d,recentEvents:u,lastResult:m,verifyAction:h,enrollConsentAcceptedAt:p,enrollDescriptors:x,enrollPhotos:f,onAction:g,onStartEnrollment:b,onNavigate:y,onNavigatePath:N,onBindStaff:w,onClearStaffBinding:j,onLogout:v,onVerifyCompleted:k,onConsentAccepted:P,onCaptureCompleted:T,onCaptureReset:_,onEnrollmentSaved:S}){return t==="/m/enroll/consent"?e.jsx(ht,{staffName:i,onNavigate:y,children:e.jsx(Or,{onBack:()=>y("/m/home"),onAccepted:P})}):t==="/m/enroll/capture"?e.jsx(ht,{staffName:i,onNavigate:y,fullBleed:!0,children:e.jsx(Ar,{consentAcceptedAt:p,initialDescriptors:x,initialPhotos:f,onBack:()=>y("/m/enroll/consent"),onReset:_,onCompleted:T})}):t==="/m/enroll/liveness"?e.jsx(ht,{staffName:i,onNavigate:y,children:e.jsx($r,{consentAcceptedAt:p,descriptors:x,photos:f,onBack:()=>y("/m/enroll/capture"),onRestart:b,onSaved:S})}):t==="/m/verify"?e.jsx(xo,{action:h,onBack:()=>y("/m/home"),onCompleted:k}):t==="/m/result"?e.jsx(Qr,{currentRoute:t,result:m,onNavigatePath:N,onNavigate:y}):t==="/m/history"?e.jsx(Wr,{currentRoute:t,staffName:i,events:u,onNavigate:y}):t==="/m/profile"?e.jsx(zr,{currentRoute:t,dbReady:s,enrollStatus:n,descriptorCount:a,staffBound:r,staffId:o,staffName:i,online:c,onStartEnrollment:b,onBindStaff:w,onClearStaffBinding:j,onNavigate:y,onLogout:v}):e.jsx(Gr,{currentRoute:t,dbReady:s,enrollStatus:n,staffBound:r,staffName:i,online:c,latestSyncState:d,recentEvents:u,onAction:g,onStartEnrollment:b,onNavigate:y})}function go({staffId:t,onSubmit:s,onLogout:n}){const[a,r]=l.useState(""),[o,i]=l.useState(""),[c,d]=l.useState(""),[u,m]=l.useState(!1),[h,p]=l.useState(null),x=l.useCallback(async()=>{if(o!==c){p("New password and confirmation do not match.");return}m(!0),p(null);try{await s({currentPassword:a,newPassword:o})}catch(f){p(f instanceof Error?f.message:"Failed to update password.")}finally{m(!1)}},[c,a,o,s]);return e.jsx("div",{className:"ui-shell",children:e.jsx("main",{className:"ui-container max-w-md space-y-4 py-6",children:e.jsxs("section",{className:"ui-card p-5",children:[e.jsx("p",{className:"ui-kicker",children:"Security Check"}),e.jsx("h1",{className:"ui-title mt-2 text-2xl",children:"Change Password"}),e.jsxs("p",{className:"ui-note mt-2",children:["Account ",e.jsx("strong",{children:t})," must change password before using attendance features."]}),e.jsx("p",{className:"ui-note mt-1",children:"Password must be 6-64 characters."}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Current Password",e.jsx("input",{value:a,onChange:f=>r(f.target.value),type:"password",className:"ui-input",autoComplete:"current-password",placeholder:"Enter current password"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["New Password",e.jsx("input",{value:o,onChange:f=>i(f.target.value),type:"password",className:"ui-input",autoComplete:"new-password",placeholder:"Enter new password"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Confirm New Password",e.jsx("input",{value:c,onChange:f=>d(f.target.value),type:"password",className:"ui-input",autoComplete:"new-password",placeholder:"Confirm new password"})]})]}),h?e.jsx("p",{className:"ui-note-error mt-3",children:h}):null,e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{x()},disabled:u,className:"ui-btn ui-btn-primary flex-1 disabled:cursor-not-allowed disabled:opacity-60",children:u?"Updating...":"Update Password"}),e.jsx("button",{type:"button",onClick:n,className:"ui-btn ui-btn-ghost",children:"Logout"})]})]})})})}function bo(t){return new URLSearchParams(t).get("action")==="OUT"?"OUT":"IN"}function wo(){const[t,s]=l.useState(()=>as()),[n,a]=l.useState(!1),[r,o]=l.useState("PENDING_CONSENT"),[i,c]=l.useState(0),[d,u]=l.useState(!1),[m,h]=l.useState(null),[p,x]=l.useState(null),[f,g]=l.useState(()=>navigator.onLine),[b,y]=l.useState("SYNCED"),[N,w]=l.useState([]),[j,v]=l.useState(null),[k,P]=l.useState(null),[T,_]=l.useState([]),[S,L]=l.useState([]),[R,E]=l.useState(null),[H,F]=l.useState(null),$=l.useCallback(async()=>{try{const I=await St(30);w(I),I.length>0&&y(I[0].syncState)}catch(I){E(I instanceof Error?I.message:"Failed to load recent events.")}},[]),D=l.useCallback(async()=>{try{const I=await Tr();o(I.status),c(I.descriptorCount),u(I.staffBound),h(I.staffId),x(I.staffName)}catch(I){E(I instanceof Error?I.message:"Failed to load enrollment status.")}},[]),{staffSession:V,refreshSessionState:B,handleStaffPasswordChange:W,handleStaffLogout:Z,handleBindStaff:ae,handleClearStaffBinding:C}=ja({refreshEnrollment:D,refreshRecentEvents:$,setAppError:E,setAppNotice:F,setStaffBound:u,setStaffId:h,setStaffName:x,setEnrollStatus:o,setDescriptorCount:c,setLastResult:v});l.useEffect(()=>{const I=()=>s(as());return window.addEventListener("popstate",I),()=>window.removeEventListener("popstate",I)},[]),l.useEffect(()=>{window.location.pathname!==t.route&&M(t.route,!0)},[t.route]),l.useEffect(()=>{let I=!1;return(async()=>{try{const{pouchDBService:pe}=await q(async()=>{const{pouchDBService:Y}=await Promise.resolve().then(()=>ne);return{pouchDBService:Y}},void 0);if(I)return;pe.init(),a(!0),await B(),await Promise.all([$(),D()])}catch(pe){I||E(pe instanceof Error?pe.message:"Failed to initialize local database.")}})(),()=>{I=!0}},[D,$,B]),l.useEffect(()=>{n&&((t.route==="/m/home"||t.route==="/m/history")&&$(),(t.route==="/m/home"||t.route==="/m/profile")&&(D(),B()))},[n,D,$,B,t.route]),l.useEffect(()=>{const I=()=>g(!0),xe=()=>g(!1);return window.addEventListener("online",I),window.addEventListener("offline",xe),()=>{window.removeEventListener("online",I),window.removeEventListener("offline",xe)}},[]),l.useEffect(()=>{if(!n)return;const I=t.route;if(!V){M("/login?role=staff",!0);return}if(V?.mustChangePassword&&I!=="/m/change-password"){M("/m/change-password",!0);return}V&&!V.mustChangePassword&&(I==="/m/login"||I==="/m/change-password")&&M("/m/home",!0)},[n,t.route,V]);const U=l.useMemo(()=>bo(t.search),[t.search]),ee=l.useCallback(I=>M(I),[]),Ee=l.useCallback(I=>M(I),[]),J=l.useCallback(()=>{if(!d){E("No staff is bound to this session. Please contact admin."),M("/m/profile");return}F(null),P(null),_([]),L([]),Nt(),M("/m/enroll/consent")},[d]);l.useEffect(()=>{t.route==="/m/verify"&&r!=="ACTIVE"&&J()},[r,J,t.route]);const re=l.useCallback(I=>{P(I),_([]),L([]),M("/m/enroll/capture")},[]),A=l.useCallback(I=>{_(I.descriptors),L(I.photos),M("/m/enroll/liveness")},[]),O=l.useCallback(I=>{(async()=>(await D(),P(null),_([]),L([]),Nt(),E(null),F(I),M("/m/home")))()},[D]),oe=l.useCallback(I=>{if(r!=="ACTIVE"){J();return}M(`/m/verify?action=${I}`)},[r,J]),ie=l.useCallback(I=>{v(I),y(I.syncState),F(null),$(),M("/m/result")},[$]),fe=t.route??_t,rt=["/m/home","/m/history","/m/profile","/m/enroll/consent","/m/enroll/capture","/m/enroll/liveness"].includes(fe),Fe=R??H,Ce=Fe?e.jsx("div",{className:rt?"px-4 pt-4 sm:px-8 lg:pr-8 lg:pl-72":"px-4 pt-4 sm:px-8",children:e.jsx("div",{className:R?"ui-banner-error":"ui-banner-success",children:Fe})}):null;return fe==="/m/login"?(M("/login?role=staff",!0),e.jsx(e.Fragment,{children:Ce})):fe==="/m/change-password"?e.jsxs(e.Fragment,{children:[Ce,e.jsx(go,{staffId:V?.staffId??"",onSubmit:W,onLogout:Z})]}):e.jsxs(e.Fragment,{children:[Ce,e.jsx(po,{currentRoute:fe,dbReady:n,enrollStatus:r,descriptorCount:i,staffBound:d,staffId:m,staffName:p,online:f,latestSyncState:b,recentEvents:N,lastResult:j,verifyAction:U,enrollConsentAcceptedAt:k,enrollDescriptors:T,enrollPhotos:S,onAction:oe,onStartEnrollment:J,onNavigate:ee,onNavigatePath:Ee,onBindStaff:ae,onClearStaffBinding:C,onLogout:Z,onVerifyCompleted:ie,onConsentAccepted:re,onCaptureCompleted:A,onCaptureReset:()=>{_([]),L([])},onEnrollmentSaved:O})]})}const Qe="satts.admin.session",No=480*60*1e3;function Bt(){return typeof window<"u"&&typeof window.localStorage<"u"}function yo(t){try{const s=JSON.parse(t),n=s.role,a=n==="SUPER_ADMIN"||n==="ADMIN";return typeof s.adminId=="string"&&typeof s.name=="string"&&typeof s.email=="string"&&a&&typeof s.issuedAt=="string"&&typeof s.expiresAt=="string"?{adminId:s.adminId,name:s.name,email:s.email,role:n,issuedAt:s.issuedAt,expiresAt:s.expiresAt}:null}catch{return null}}function jo(t){const s=Date.parse(t);return Number.isFinite(s)?Date.now()>=s:!0}function Hs(t,s=No){const n=new Date,a={adminId:t.adminId,name:t.name,email:t.email,role:t.role,issuedAt:n.toISOString(),expiresAt:new Date(n.getTime()+s).toISOString()};return Bt()&&window.localStorage.setItem(Qe,JSON.stringify(a)),a}function vt(){if(!Bt())return null;const t=window.localStorage.getItem(Qe);if(!t)return null;const s=yo(t);return!s||jo(s.expiresAt)?(window.localStorage.removeItem(Qe),null):s}function vo(){Bt()&&window.localStorage.removeItem(Qe)}class ue{static instance;db=null;defaultDbName="satts_db";constructor(){}static getInstance(){return ue.instance||(ue.instance=new ue),ue.instance}assertBrowserSupport(){if(typeof indexedDB>"u")throw new Error("PouchDB IndexedDB adapter is unavailable in this runtime. Use browser mode or inject a test database.")}init(s=this.defaultDbName){return this.db||(this.assertBrowserSupport(),this.db=new an(s)),this.db}getDatabase(){return this.init()}setDatabase(s){this.db=s}async put(s){return this.getDatabase().put(s)}async get(s){return this.getDatabase().get(s)}sync(s,n={live:!0,retry:!0}){return this.getDatabase().sync(s,n)}}const me=ue.getInstance(),ne=Object.freeze(Object.defineProperty({__proto__:null,PouchDBService:ue,pouchDBService:me},Symbol.toStringTag,{value:"Module"})),So="org_01",Vs="system_admin::primary",Eo=12e3;function Co(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}function Io(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===409||s.name==="conflict"}function Ys(t){return t.trim().replace(/\s+/g," ")}function nt(t){return t.trim().toLowerCase()}function Ao(t){const s=Ys(t.name),n=nt(t.email),a=t.pin.trim();if(s.length<2)throw new Error("Admin name must be at least 2 characters.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))throw new Error("Please provide a valid admin email.");if(!/^\d{6}$/.test(a))throw new Error("PIN must be exactly 6 digits.")}function ko(t){const s=nt(t.email),n=t.pin.trim();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))throw new Error("Please provide a valid admin email.");if(!/^\d{6}$/.test(n))throw new Error("PIN must be exactly 6 digits.")}function Ut(t,s){return new Promise((n,a)=>{const r=window.setTimeout(()=>{a(new Error(`${s} timed out. Please retry.`))},Eo);t.then(o=>{window.clearTimeout(r),n(o)}).catch(o=>{window.clearTimeout(r),a(o)})})}async function Gs(t){const s=new TextEncoder().encode(t);if(typeof crypto<"u"&&crypto.subtle){const a=await Ut(crypto.subtle.digest("SHA-256",s),"PIN hashing");return`sha256:${Array.from(new Uint8Array(a),o=>o.toString(16).padStart(2,"0")).join("")}`}return`base64:${btoa(String.fromCharCode(...s))}`}async function Wt(){return me.init(),me.getDatabase()}async function Ht(){const t=await Wt();try{return await Ut(t.get(Vs),"Load system admin")}catch(s){if(Co(s))return null;throw s}}async function _o(){return await Ht()!==null}async function Do(t){Ao(t);const s=await Wt(),n=new Date().toISOString(),a=Ys(t.name),r=nt(t.email),o={_id:Vs,type:"SYSTEM_ADMIN",orgId:So,adminId:"admin_001",name:a,email:r,role:"SUPER_ADMIN",pinHash:await Gs(t.pin.trim()),createdAt:n,lastLoginAt:n};let i;try{i=await Ut(s.put(o),"Create system admin")}catch(c){throw Io(c)?new Error("System admin already exists. Please sign in at /admin/login."):c}return{...o,_rev:i.rev}}async function Lo(t){ko(t);const s=await Ht();if(!s)throw new Error("System admin not found. Complete setup first.");const n=nt(t.email),a=t.pin.trim(),r=await Gs(a);if(s.email!==n||s.pinHash!==r)throw new Error("Invalid email or PIN.");const o=await Wt(),i={...s,lastLoginAt:new Date().toISOString()};try{const c=await o.put(i);return{...i,_rev:c.rev}}catch{return s}}function Mo({selectedId:t,editorText:s,readOnlyMode:n,saving:a,pendingDeleteId:r,deleteConfirmInput:o,onEditorTextChange:i,onSave:c,onRequestDelete:d,onDeleteConfirmInputChange:u,onConfirmDelete:m,onCancelDelete:h}){return e.jsxs("div",{className:"ui-card p-4 lg:col-span-8",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h2",{className:"ui-title text-sm",children:"JSON Editor"}),e.jsx("span",{className:"ui-note-xs",children:t??"No doc selected"})]}),e.jsx("textarea",{value:s,onChange:p=>i(p.target.value),readOnly:n,className:"min-h-[60vh] w-full rounded-xl border border-slate-200 bg-slate-950 p-3 font-mono text-xs text-slate-100 outline-none focus:ring-4 focus:ring-slate-100",placeholder:'Click "Refresh DB" and open a document.',spellCheck:!1}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:c,disabled:!s||a||n,className:"ui-btn ui-btn-success disabled:cursor-not-allowed disabled:opacity-60",children:a?"Saving...":"Save JSON"}),e.jsx("button",{type:"button",onClick:d,disabled:!s||a||n,className:"ui-btn ui-btn-danger disabled:cursor-not-allowed disabled:opacity-60",children:"Request Delete"})]}),r?e.jsxs("div",{className:"mt-3 rounded-xl border border-rose-200 bg-rose-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-800",children:"Delete confirm required. Type exact _id:"}),e.jsx("p",{className:"mt-1 break-all font-mono text-xs text-rose-700",children:r}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("input",{value:o,onChange:p=>u(p.target.value),className:"ui-input mt-0 max-w-md",placeholder:"Type exact _id to confirm delete"}),e.jsx("button",{type:"button",onClick:m,disabled:a,className:"ui-btn ui-btn-danger disabled:cursor-not-allowed disabled:opacity-60",children:"Confirm Delete"}),e.jsx("button",{type:"button",onClick:h,className:"ui-btn ui-btn-ghost",children:"Cancel"})]})]}):null]})}function Po({records:t,filterText:s,selectedId:n,onFilterTextChange:a,onOpenRecord:r}){return e.jsxs("div",{className:"ui-card p-4 lg:col-span-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h2",{className:"ui-title text-sm",children:"Documents"}),e.jsx("span",{className:"ui-note-xs",children:t.length})]}),e.jsx("input",{value:s,onChange:o=>a(o.target.value),className:"ui-input mt-0",placeholder:"Filter by _id or type..."}),e.jsx("ul",{className:"mt-3 max-h-[60vh] space-y-2 overflow-y-auto pr-1",children:t.map(o=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>r(o._id),className:`w-full rounded-xl border px-3 py-2 text-left text-xs transition-colors ${n===o._id?"border-sky-300 bg-sky-50 text-sky-900":"border-slate-200 bg-white text-slate-700 hover:bg-slate-50"}`,children:[e.jsx("p",{className:"font-mono font-semibold",children:o._id}),e.jsx("p",{className:"mt-1 text-[10px] text-slate-500",children:String(o.type??"UNKNOWN")})]})},o._id))})]})}function To(t){if(t===null||typeof t!="object")return!1;const s=t;return s.status===404||s.name==="not_found"}function zs(t){return t===null||typeof t!="object"?!1:typeof t._id=="string"}async function at(){return me.init(),me.getDatabase()}async function Ro(t=500){const n=await(await at()).allDocs({include_docs:!0,limit:t}),a=[];for(const r of n.rows)zs(r.doc)&&a.push(r.doc);return a.sort((r,o)=>r._id.localeCompare(o._id))}async function Oo(t){const s=await at();try{const n=await s.get(t);return zs(n)?n:null}catch(n){if(To(n))return null;throw n}}async function Fo(t){if(!t._id||typeof t._id!="string")throw new Error("Document must contain string _id.");const n=await(await at()).put(t);return{...t,_rev:n.rev}}async function $o(t){const s=await at();if(!t._rev){const n=await s.get(t._id);await s.remove(n);return}await s.remove({_id:t._id,_rev:t._rev})}function ft(t){return JSON.stringify(t,null,2)}function gs({adminSession:t}){const[s,n]=l.useState(!0),[a,r]=l.useState(""),[o,i]=l.useState(null),[c,d]=l.useState(""),[u,m]=l.useState([]),[h,p]=l.useState(""),[x,f]=l.useState(null),[g,b]=l.useState(""),[y,N]=l.useState(!1),[w,j]=l.useState(!1),[v,k]=l.useState(null),[P,T]=l.useState(null),_="ENABLE_EDIT",S=t?.role==="SUPER_ADMIN",L=t?.role??"NO_SESSION";l.useEffect(()=>{S||(n(!0),r(""),i(null),d(""))},[S]);const R=l.useMemo(()=>{const C=h.trim().toLowerCase();return C?u.filter(U=>{const ee=typeof U.type=="string"?U.type.toLowerCase():"";return U._id.toLowerCase().includes(C)||ee.includes(C)}):u},[h,u]),E=l.useCallback(async()=>{N(!0),k(null);try{const C=await Ro(800);m(C),T(`Loaded ${C.length} docs from IndexedDB.`)}catch(C){k(C instanceof Error?C.message:"Failed to read database."),T(null)}finally{N(!1)}},[]),H=l.useCallback(async C=>{k(null);try{const U=await Oo(C);if(!U){k(`Doc ${C} not found.`);return}f(C),b(ft(U)),i(null),d(""),T(`Opened ${C}`)}catch(U){k(U instanceof Error?U.message:"Failed to load doc.")}},[]),F=l.useCallback(()=>{const C=`doc::${Date.now()}`,U={_id:C,type:"CUSTOM",createdAt:new Date().toISOString()};f(C),b(ft(U)),i(null),d(""),T("Blank doc template generated. Edit JSON then click Save."),k(null)},[]),$=l.useCallback(async()=>{j(!0),k(null);try{const C=JSON.parse(g),U=await Fo(C);f(U._id),b(ft(U)),T(`Saved ${U._id}`),await E()}catch(C){k(C instanceof Error?C.message:"Failed to save doc."),T(null)}finally{j(!1)}},[g,E]),D=l.useCallback(async()=>{j(!0),k(null);try{const C=JSON.parse(g);await $o({_id:C._id,_rev:C._rev}),T(`Deleted ${C._id}`),f(null),b(""),i(null),d(""),await E()}catch(C){k(C instanceof Error?C.message:"Failed to delete doc."),T(null)}finally{j(!1)}},[g,E]),V=l.useCallback(()=>{if(!S){k("Write access is restricted to Super Admin.");return}if(a.trim()!==_){k(`Type ${_} to enable edit mode.`);return}n(!1),r(""),k(null),T("Edit mode enabled. Be careful with save/delete operations.")},[S,_,a]),B=l.useCallback(()=>{n(!0),i(null),d(""),k(null),T("Switched to read-only mode.")},[]),W=l.useCallback(()=>{try{const C=JSON.parse(g);if(!C._id){k("Current JSON must include _id before delete.");return}i(C._id),d(""),k(null),T(`Delete requested for ${C._id}. Type the exact _id to confirm.`)}catch(C){k(C instanceof Error?C.message:"Invalid JSON.")}},[g]),Z=l.useCallback(async()=>{if(o){if(c.trim()!==o){k("Delete confirmation text does not match _id.");return}await D()}},[c,D,o]),ae=l.useCallback(()=>{i(null),d("")},[]);return e.jsx("div",{className:"ui-shell",children:e.jsxs("main",{className:"ui-container max-w-7xl space-y-4",children:[e.jsxs("section",{className:"ui-card p-4",children:[e.jsx("p",{className:"ui-kicker",children:"Debug"}),e.jsx("h1",{className:"ui-title text-xl",children:"IndexedDB Explorer"}),e.jsx("p",{className:"ui-note mt-1",children:"View and manage PouchDB documents directly (similar to phpMyAdmin style, JSON-level)."}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{E()},className:"ui-btn ui-btn-primary",children:y?"Loading...":"Refresh DB"}),e.jsx("button",{type:"button",onClick:F,disabled:s||!S,className:"ui-btn ui-btn-ghost disabled:cursor-not-allowed disabled:opacity-60",children:"New Doc"}),S&&s?e.jsxs(e.Fragment,{children:[e.jsx("input",{value:a,onChange:C=>r(C.target.value),className:"ui-input mt-0 max-w-[12rem]",placeholder:`Type ${_}`}),e.jsx("button",{type:"button",onClick:V,className:"ui-btn ui-btn-info",children:"Enable Edit Mode"})]}):null,S&&!s?e.jsx("button",{type:"button",onClick:B,className:"ui-btn ui-btn-danger",children:"Lock Read-Only"}):null,e.jsx("button",{type:"button",onClick:()=>M("/debug/health"),className:"ui-btn ui-btn-ghost",children:"Back to Health"})]}),e.jsxs("p",{className:"ui-note mt-2",children:["Mode: ",e.jsx("strong",{children:s?"READ-ONLY":"EDIT ENABLED"})]}),e.jsxs("p",{className:"ui-note mt-1",children:["Session Role: ",e.jsx("strong",{children:L})," 路 Write Permission: ",e.jsx("strong",{children:S?"ALLOWED":"DENIED"})]}),v?e.jsx("p",{className:"ui-note-error mt-2",children:v}):null,P?e.jsx("p",{className:"ui-note mt-2 text-emerald-700",children:P}):null]}),e.jsxs("section",{className:"grid gap-4 lg:grid-cols-12",children:[e.jsx(Po,{records:R,filterText:h,selectedId:x,onFilterTextChange:p,onOpenRecord:C=>{H(C)}}),e.jsx(Mo,{selectedId:x,editorText:g,readOnlyMode:s,saving:w,pendingDeleteId:o,deleteConfirmInput:c,onEditorTextChange:b,onSave:()=>{$()},onRequestDelete:W,onDeleteConfirmInputChange:d,onConfirmDelete:()=>{Z()},onCancelDelete:ae})]})]})})}const Bo=8e3;function Te(t,s){return new Promise((n,a)=>{const r=window.setTimeout(()=>{a(new Error(`${s} timed out.`))},Bo);t.then(o=>{window.clearTimeout(r),n(o)}).catch(o=>{window.clearTimeout(r),a(o)})})}async function we(t,s,n){const a=performance.now();try{const r=await n();return{id:t,label:s,status:r.status,detail:r.detail,durationMs:Math.round(performance.now()-a)}}catch(r){return{id:t,label:s,status:"FAIL",detail:r instanceof Error?r.message:"Unknown error",durationMs:Math.round(performance.now()-a)}}}async function Uo(){if(typeof indexedDB>"u")return{status:"FAIL",detail:"indexedDB is unavailable."};const t=await Te(new Promise(s=>{const n=indexedDB.open("satts_probe_db",1);n.onupgradeneeded=()=>{},n.onsuccess=()=>{n.result.close(),s("open-ok")},n.onerror=()=>s(`open-error:${n.error?.name??"unknown"}`),n.onblocked=()=>s("blocked")}),"IndexedDB open");return t==="open-ok"?{status:"PASS",detail:"IndexedDB open successful."}:{status:"FAIL",detail:`IndexedDB probe failed: ${t}`}}async function Wo(){if(typeof window>"u"||typeof window.localStorage>"u")return{status:"FAIL",detail:"localStorage unavailable."};const t=`satts_probe::${Date.now()}`;window.localStorage.setItem(t,"ok");const s=window.localStorage.getItem(t);return window.localStorage.removeItem(t),s==="ok"?{status:"PASS",detail:"localStorage read/write successful."}:{status:"FAIL",detail:"localStorage probe value mismatch."}}async function Ho(){if(typeof crypto>"u"||!crypto.subtle)return{status:"WARN",detail:"crypto.subtle unavailable. Fallback hash path may be used."};const t=new TextEncoder().encode("satts-crypto-probe");return await Te(crypto.subtle.digest("SHA-256",t),"crypto.subtle.digest"),{status:"PASS",detail:"crypto.subtle digest successful."}}async function Vo(){me.init();const t=me.getDatabase(),s=await Te(t.info(),"PouchDB info"),n=`probe::${Date.now()}`;return await Te(t.put({_id:n,type:"DEBUG_PROBE",createdAt:new Date().toISOString()}),"PouchDB put"),{status:"PASS",detail:`PouchDB ready (name=${s.db_name}, doc_count=${s.doc_count}).`}}async function Yo(){const t=await Te(Ht(),"Load system admin");return t?{status:"PASS",detail:`SYSTEM_ADMIN found (${t.email}).`}:{status:"WARN",detail:"SYSTEM_ADMIN not found. Setup is expected."}}async function Go(){const t=vt();return t?{status:"PASS",detail:`Session active for ${t.email}, expires at ${t.expiresAt}.`}:{status:"WARN",detail:"No active admin session."}}async function zo(){const t=await Promise.all([we("indexeddb","IndexedDB",Uo),we("localstorage","localStorage",Wo),we("crypto","Web Crypto",Ho),we("pouchdb","PouchDB",Vo),we("system-admin","System Admin Doc",Yo),we("admin-session","Admin Session",Go)]);return{generatedAt:new Date().toISOString(),checks:t}}function qo(t){switch(t){case"PASS":return"text-emerald-700";case"WARN":return"text-amber-700";default:return"text-rose-700"}}function bs(){const[t,s]=l.useState(null),[n,a]=l.useState(!1),[r,o]=l.useState(null),i=l.useMemo(()=>t?JSON.stringify(t,null,2):"",[t]),c=l.useCallback(async()=>{a(!0),o(null);try{const u=await zo();s(u)}catch(u){o(u instanceof Error?u.message:"Failed to run debug checks."),s(null)}finally{a(!1)}},[]),d=l.useCallback(async()=>{i&&await navigator.clipboard.writeText(i)},[i]);return e.jsx("div",{className:"ui-shell",children:e.jsxs("main",{className:"ui-container max-w-4xl space-y-4",children:[e.jsxs("section",{className:"ui-card p-6",children:[e.jsx("p",{className:"ui-kicker",children:"Debug"}),e.jsx("h1",{className:"ui-title mt-2 text-2xl",children:"System Health"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"Run checks for browser storage, PouchDB, admin document, and session state."}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{c()},disabled:n,className:"ui-btn ui-btn-primary min-w-[12rem] disabled:cursor-not-allowed disabled:opacity-60",children:n?"Running...":"Run Diagnostics"}),e.jsx("button",{type:"button",onClick:d,disabled:!i,className:"ui-btn ui-btn-ghost min-w-[10rem] disabled:cursor-not-allowed disabled:opacity-60",children:"Copy JSON"}),e.jsx("button",{type:"button",onClick:()=>M("/debug/db"),className:"ui-btn ui-btn-ghost",children:"Open DB Explorer"}),e.jsx("button",{type:"button",onClick:()=>M("/setup/admin"),className:"ui-btn ui-btn-ghost",children:"Back to Setup"})]}),r?e.jsx("p",{className:"ui-note-error mt-4",children:r}):null]}),t?e.jsxs("section",{className:"ui-card p-6",children:[e.jsxs("p",{className:"ui-note-xs",children:["Generated At: ",t.generatedAt]}),e.jsx("ul",{className:"mt-4 space-y-3",children:t.checks.map(u=>e.jsxs("li",{className:"rounded-xl border border-slate-100 bg-white p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-900",children:u.label}),e.jsxs("p",{className:`text-xs font-bold ${qo(u.status)}`,children:[u.status," 路 ",u.durationMs,"ms"]})]}),e.jsx("p",{className:"mt-1 text-xs text-slate-600",children:u.detail})]},u.id))})]}):null]})})}function Ko(){return e.jsx("div",{className:"ui-shell",children:e.jsxs("main",{className:"ui-container",children:[e.jsxs("header",{className:"ui-card rounded-2xl p-6",children:[e.jsx("p",{className:"ui-kicker",children:"SATTS"}),e.jsx("h1",{className:"ui-title mt-2 text-2xl sm:text-3xl",children:"Attendance & Time Tracking"}),e.jsx("p",{className:"ui-text mt-2 text-sm sm:text-base",children:"Responsive workspace for staff mobile attendance and HR admin operations."})]}),e.jsxs("section",{className:"mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-3",children:[e.jsxs("article",{className:"ui-card p-5",children:[e.jsx("p",{className:"ui-kicker",children:"Mobile"}),e.jsx("h2",{className:"ui-title mt-2 text-lg",children:"Staff Attendance"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"Time In/Out, enrollment, offline sync state, and evidence capture flow."}),e.jsx("button",{type:"button",onClick:()=>M("/m/home"),className:"ui-btn ui-btn-primary mt-4 w-full",children:"Open Staff App"})]}),e.jsxs("article",{className:"ui-card p-5",children:[e.jsx("p",{className:"ui-kicker",children:"PC"}),e.jsx("h2",{className:"ui-title mt-2 text-lg",children:"Admin Console"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"Logs, staff reset, settings, exports, and audit in a multi-panel desktop layout."}),e.jsx("button",{type:"button",onClick:()=>M("/admin/logs"),className:"ui-btn ui-btn-success mt-4 w-full",children:"Open Admin Console"})]}),e.jsxs("article",{className:"ui-card p-5 md:col-span-2 xl:col-span-1",children:[e.jsx("p",{className:"ui-kicker",children:"Tablet"}),e.jsx("h2",{className:"ui-title mt-2 text-lg",children:"Hybrid Layout"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"Staff pages auto-expand to tablet spacing with persistent navigation for touch ergonomics."}),e.jsx("button",{type:"button",onClick:()=>M("/m/history"),className:"ui-btn ui-btn-info mt-4 w-full",children:"Preview Tablet Staff"})]})]})]})})}const Jo="/admin/logs";function Xo(t){return!t||!t.startsWith("/")||t.startsWith("//")?Jo:t}function Qo(t){return t instanceof Error?t.message.includes("has no password")?`${t.message} Ask admin to use Staff Management > Reset Password.`:t.message:"Failed to sign in."}function xt({preferredRole:t,adminNextPath:s,onAdminLoginSuccess:n}){const[a,r]=l.useState(t),[o,i]=l.useState(!1),[c,d]=l.useState(null),[u,m]=l.useState(""),[h,p]=l.useState(""),[x,f]=l.useState(""),[g,b]=l.useState("");l.useEffect(()=>{r(t),d(null)},[t]);const y=l.useCallback(async()=>{if(!u.trim()||!h.trim()){d("Staff ID and password are required.");return}i(!0),d(null);try{const w=await Ct({staffId:u,password:h}),j=w.credentials?.mustChangePassword??!0;bt({staffId:w.staffId,name:w.name},j),De(w.staffId),M(j?"/m/change-password":"/m/home",!0)}catch(w){d(Qo(w))}finally{i(!1)}},[u,h]),N=l.useCallback(async()=>{i(!0),d(null);try{const w=await Lo({email:x,pin:g}),j=Hs({adminId:w.adminId,name:w.name,email:w.email,role:w.role});n(j,Xo(s))}catch(w){d(w instanceof Error?w.message:"Failed to sign in.")}finally{i(!1)}},[x,s,g,n]);return e.jsx("div",{className:"ui-shell",children:e.jsx("main",{className:"ui-container max-w-2xl",children:e.jsxs("section",{className:"ui-card p-6 sm:p-8",children:[e.jsx("p",{className:"ui-kicker",children:"Unified Access"}),e.jsx("h1",{className:"ui-title mt-2 text-2xl sm:text-3xl",children:"Sign In"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"Staff and Admin now share one login page."}),e.jsxs("div",{className:"mt-5 inline-flex rounded-xl border border-slate-200 bg-slate-50 p-1",children:[e.jsx("button",{type:"button",onClick:()=>r("staff"),className:`ui-btn min-h-0 px-3 py-1.5 text-xs ${a==="staff"?"ui-btn-primary":"ui-btn-ghost"}`,children:"Staff Login"}),e.jsx("button",{type:"button",onClick:()=>r("admin"),className:`ui-btn min-h-0 px-3 py-1.5 text-xs ${a==="admin"?"ui-btn-primary":"ui-btn-ghost"}`,children:"Admin Login"})]}),c?e.jsx("p",{className:"ui-note-error mt-4",children:c}):null,a==="staff"?e.jsxs("div",{className:"mt-6 grid gap-4",children:[e.jsx("p",{className:"ui-note text-amber-700",children:"First login requires password change."}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Staff ID",e.jsx("input",{value:u,onChange:w=>m(w.target.value.toUpperCase()),className:"ui-input",placeholder:"STAFF_001"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Password",e.jsx("input",{value:h,onChange:w=>p(w.target.value),type:"password",className:"ui-input",autoComplete:"current-password",placeholder:"Enter password"})]}),e.jsx("button",{type:"button",onClick:()=>{y()},disabled:o,className:"ui-btn ui-btn-primary w-full disabled:cursor-not-allowed disabled:opacity-60",children:o?"Signing In...":"Sign In as Staff"})]}):e.jsxs("div",{className:"mt-6 grid gap-4",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Admin Email",e.jsx("input",{value:x,onChange:w=>f(w.target.value),className:"ui-input",placeholder:"admin@company.com",autoComplete:"email"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["6-digit PIN",e.jsx("input",{value:g,onChange:w=>b(w.target.value),className:"ui-input",placeholder:"123456",maxLength:6,inputMode:"numeric",autoComplete:"current-password"})]}),e.jsx("button",{type:"button",onClick:()=>{N()},disabled:o,className:"ui-btn ui-btn-primary w-full disabled:cursor-not-allowed disabled:opacity-60",children:o?"Signing In...":"Sign In as Admin"})]})]})})})}const Zo=15e3;function ei(t,s){return new Promise((n,a)=>{const r=window.setTimeout(()=>{a(new Error("Create admin request timed out. Please retry."))},s);t.then(o=>{window.clearTimeout(r),n(o)}).catch(o=>{window.clearTimeout(r),a(o)})})}function ti({onSetupCompleted:t}){const[s,n]=l.useState(""),[a,r]=l.useState(""),[o,i]=l.useState(""),[c,d]=l.useState(""),[u,m]=l.useState(!1),[h,p]=l.useState(null),[x,f]=l.useState(null),g=l.useCallback(async()=>{const b=o.trim(),y=c.trim();if(b!==y){p("PIN confirmation does not match."),f(null);return}m(!0),p(null),f(null);try{const N=await ei(Do({name:s,email:a,pin:b}),Zo),w=Hs({adminId:N.adminId,name:N.name,email:N.email,role:N.role});f("Super Admin account created. Redirecting to admin console..."),t(w)}catch(N){p(N instanceof Error?N.message:"Failed to create system admin."),f(null)}finally{m(!1)}},[c,a,s,t,o]);return e.jsx("div",{className:"ui-shell",children:e.jsx("main",{className:"ui-container max-w-3xl",children:e.jsxs("section",{className:"ui-card p-6 sm:p-8",children:[e.jsx("p",{className:"ui-kicker",children:"System Setup"}),e.jsx("h1",{className:"ui-title mt-2 text-2xl sm:text-3xl",children:"Create Super Admin"}),e.jsx("p",{className:"ui-text mt-2 text-sm",children:"First-time initialization. This step is required before staff enrollment and attendance workflow."}),h?e.jsx("p",{className:"ui-note-error mt-4",children:h}):null,x?e.jsx("p",{className:"ui-note mt-4 text-emerald-700",children:x}):null,e.jsxs("div",{className:"mt-6 grid gap-4 sm:grid-cols-2",children:[e.jsxs("label",{className:"text-sm text-slate-700 sm:col-span-2",children:["Admin Name",e.jsx("input",{value:s,onChange:b=>n(b.target.value),className:"ui-input",placeholder:"e.g. System Owner",autoComplete:"name"})]}),e.jsxs("label",{className:"text-sm text-slate-700 sm:col-span-2",children:["Admin Email",e.jsx("input",{value:a,onChange:b=>r(b.target.value),className:"ui-input",placeholder:"admin@company.com",autoComplete:"email"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["6-digit PIN",e.jsx("input",{value:o,onChange:b=>i(b.target.value),className:"ui-input",placeholder:"123456",inputMode:"numeric",maxLength:6,autoComplete:"new-password"})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Confirm PIN",e.jsx("input",{value:c,onChange:b=>d(b.target.value),className:"ui-input",placeholder:"123456",inputMode:"numeric",maxLength:6,autoComplete:"new-password"})]})]}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{g()},disabled:u,className:"ui-btn ui-btn-primary min-w-[12rem] disabled:cursor-not-allowed disabled:opacity-60",children:u?"Creating...":"Create Super Admin"}),e.jsx("button",{type:"button",onClick:()=>M("/debug/health"),className:"ui-btn ui-btn-ghost",children:"Open Debug Health"})]})]})})})}const si=12e3,qs="/login",Ye="/admin/login",ni="/m/login",pt="/admin/logs",gt="/debug/health",Ne="/debug/db",ai=3e4;function ye(t,s){const n=new URLSearchParams;return n.set("role",t),s&&s.startsWith("/")&&!s.startsWith("//")&&n.set("next",s),`${qs}?${n.toString()}`}function ri(t){return new URLSearchParams(t).get("role")==="admin"?"admin":"staff"}function oi(t){const n=new URLSearchParams(t).get("next");return!n||!n.startsWith("/")||n.startsWith("//")?null:n}function ii(t,s){return new Promise((n,a)=>{const r=window.setTimeout(()=>{a(new Error("Bootstrap check timed out."))},s);t.then(o=>{window.clearTimeout(r),n(o)}).catch(o=>{window.clearTimeout(r),a(o)})})}function li(){const[t,s]=l.useState(()=>ss()),[n,a]=l.useState("required"),[r,o]=l.useState(null),[i,c]=l.useState(()=>vt()),d=l.useCallback(async()=>{try{const x=await ii(_o(),si);a(x?"ready":"required"),o(null)}catch(x){if(a("required"),x instanceof Error&&x.message.includes("timed out")){o(null);return}o(x instanceof Error?`${x.message} Continue setup, and refresh if browser storage is blocked.`:"Failed to read setup status.")}},[]),u=l.useCallback(()=>{c(vt())},[]);l.useEffect(()=>{const x=()=>s(ss());return window.addEventListener("popstate",x),()=>window.removeEventListener("popstate",x)},[]),l.useEffect(()=>{const x=window.setInterval(u,ai),f=()=>u();return window.addEventListener("storage",f),()=>{window.clearInterval(x),window.removeEventListener("storage",f)}},[u]),l.useEffect(()=>{let x=!1;return(async()=>await d())(),()=>{x=!0}},[d]),l.useEffect(()=>{if(n==="required"&&t.pathname!=="/setup/admin"&&t.pathname!==gt&&t.pathname!==Ne){M("/setup/admin",!0);return}if(n==="ready"){if(t.pathname.startsWith("/setup/admin")){M(i?pt:ye("admin"),!0);return}if(t.pathname===Ye){M(ye("admin"),!0);return}if(t.pathname===ni){M(ye("staff"),!0);return}if(t.pathname===Ne&&!i){M(ye("admin",Ne),!0);return}if(t.pathname.startsWith("/admin")){if(!i&&t.pathname!==Ye){M(ye("admin",`${t.pathname}${t.search}`),!0);return}i&&t.pathname===Ye&&M(pt,!0)}}},[i,t.pathname,t.search,n]);const m=l.useCallback(x=>{a("ready"),o(null),c(x),M(pt,!0)},[]),h=l.useCallback((x,f)=>{c(x),M(f,!0)},[]),p=l.useCallback(()=>{vo(),c(null),M(ye("admin"),!0)},[]);return n==="required"?t.pathname===gt?e.jsx(bs,{}):t.pathname===Ne?e.jsx(gs,{adminSession:i}):e.jsxs(e.Fragment,{children:[r?e.jsx("div",{className:"ui-banner-error",children:r}):null,e.jsx(ti,{onSetupCompleted:m}),e.jsx("div",{className:"ui-shell pt-0",children:e.jsx("main",{className:"ui-container max-w-3xl",children:e.jsx("button",{type:"button",onClick:()=>{d()},className:"ui-btn ui-btn-ghost",children:"Retry Bootstrap Check"})})})]}):t.pathname===gt?e.jsx(bs,{}):t.pathname===Ne?i?e.jsx(gs,{adminSession:i}):e.jsx(xt,{preferredRole:"admin",adminNextPath:Ne,onAdminLoginSuccess:h}):t.pathname===qs?e.jsx(xt,{preferredRole:ri(t.search),adminNextPath:oi(t.search),onAdminLoginSuccess:h}):t.pathname.startsWith("/admin")?!i||t.pathname===Ye?e.jsx(xt,{preferredRole:"admin",adminNextPath:`${t.pathname}${t.search}`,onAdminLoginSuccess:h}):e.jsx(ma,{onLogout:p}):t.pathname.startsWith("/m/")?e.jsx(wo,{}):e.jsx(Ko,{})}function ci(){return e.jsx(li,{})}nn.createRoot(document.getElementById("root")).render(e.jsx(l.StrictMode,{children:e.jsx(ci,{})}));
